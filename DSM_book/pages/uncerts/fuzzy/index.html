<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>Quantification of prediction uncertainties &#8211; Smart Digital Agriculture</title>
<meta name="description" content="local errors and fuzzy clustering">


<!-- Twitter Cards -->
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="/images/">
<meta name="twitter:title" content="Quantification of prediction uncertainties">
<meta name="twitter:description" content="local errors and fuzzy clustering">
<meta name="twitter:creator" content="@soilmalone">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="Quantification of prediction uncertainties">
<meta property="og:description" content="local errors and fuzzy clustering">
<meta property="og:url" content="/DSM_book/pages/uncerts/fuzzy/">
<meta property="og:site_name" content="Smart Digital Agriculture">

<meta name="google-site-verification" content="googledd99b1430269a639.html">



<link rel="canonical" href="/DSM_book/pages/uncerts/fuzzy/">
<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Smart Digital Agriculture Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<!-- Bootstrap Core CSS -->
<link rel="stylesheet" href="/assets/css/bootstrap.min.css">
<!-- Clean Blog CSS -->
<link rel="stylesheet" href="/assets/css/clean-blog.css">
<!-- HPSTR main CSS -->
<link rel="stylesheet" href="/assets/css/main.css">

<meta http-equiv="cleartype" content="on">

<!-- Load Modernizr -->
<script src="/assets/js/vendor/modernizr-2.6.2.custom.min.js"></script>

<!-- Custom Fonts -->
<link href="//fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic" rel="stylesheet" type="text/css">
<link href='//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
<link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Viga|Ubuntu:700' rel='stylesheet' type='text/css'>
<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/images/apple-touch-icon-144x144-precomposed.png">



<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->

</head>

<body id="page" >

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->
<!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Smart Digital Agriculture</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                
                    
                    <li><a href="/" >Home</a></li>
                
                    
                    <li><a href="/publications/" >Publications</a></li>
                
                    
                    <li><a href="/software/" >Software</a></li>
                
                    
                    <li><a href="/blog/" >Journal Digests</a></li>
                
                    
                    <li><a href="/UseCases/" >Blog</a></li>
                
                    
                    <li><a href="/DSM_book/" >Using R for Digital Soil Mapping</a></li>
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>

<!-- Page Header -->
<header class="intro-header" style="background-image: url('/images/pedometric2017.jpg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="site-heading">
                    <h1>Quantification of prediction uncertainties</h1>
                    
                        <hr class="small">
                        <span class="subheading">local errors and fuzzy clustering</span>
                    
                </div>
            </div>
        </div>
    </div>
</header>

<!--

-->

<div id="main" role="main">
  <article class="hentry">
    <!--
    <header class="header-title">
      <div class="header-title-wrap">
        <h1 class="entry-title">Quantification of prediction uncertainties</h1>
        
        <p class="entry-reading-time">
          <i class="fa fa-clock-o"></i>
          
          Reading time ~46 minutes
        </p>
        
      </div>
    </header>
    -->
    <div class="entry-content">
      <h4 id="code">CODE:</h4>

<p><a href="/DSM_book/rcode/P7_uncerts_fuzzy.R">Get the code used for this section here</a></p>

<h3 id="uncertainty-estimation-based-on-local-errors-and-fuzzy-clustering">Uncertainty estimation based on local errors and fuzzy clustering</h3>

<ul>
  <li><a href="#s-1">Pre-work reading</a></li>
  <li><a href="#s-2">Data preparation</a></li>
  <li><a href="#s-3">Predictive model fitting</a></li>
  <li><a href="#s-4">Estimating underlying model errors</a></li>
  <li><a href="#s-5">Fuzzy clustering with extragrades</a></li>
  <li><a href="#s-6">Evaluating the quantification of uncertainties</a></li>
  <li><a href="#s-7">Mapping predictions and model uncertainties</a></li>
  <li><a href="#s-8">References</a></li>
</ul>

<h3 id="pre-work-reading-">Pre-work reading <a id="s-1"></a></h3>

<p>Similar to the <a href="/DSM_book/pages/uncerts/partition/">uncertainty estimation based on local errors and data partitioning</a> approach, the approach used in this example is similar in that uncertainty is expressed in the form of quantiles of the underlying distribution of model errors (residuals).</p>

<p>It contrasts however in terms of how the environmental data are treated. For the <a href="/DSM_book/pages/uncerts/partition/">data partitioning</a> approach, the method was based upon the hard classification defined by the partitions made in the covariates through the definition of the cubist model rulesets. The approach followed in this example uses a fuzzy clustering method of partition.</p>

<p>Essentially the approach is based on previous research by Shrestha and Solomatine (2006) where the idea is to partition a feature space into clusters (with a fuzzy k-means routine) which share similar model errors. A prediction interval (PI) is constructed for each cluster on the basis of the empirical distribution of residual observations that belong to each cluster. A PI is then formulated for each observation in the feature space according to the grade of their memberships to each
cluster.</p>

<p>Shrestha and Solomatine (2006) applied this methodology to artificial and real hydrological data sets and it was found to be superior to other methods which estimate a PI. The Shrestha and Solomatine (2006) approach computes the PI independently and while free of the prediction model structure, it requires only the model or prediction outputs. Tranter et al. (2010) extended this approach to deal with observations that are outside of the training domain.</p>

<p>The method presented in this exercise was introduced by Malone et al. (2011) which modifies slightly the Shrestha and Solomatine (2006) and Tranter et al. (2010) approachesto enable it for a DSM framework. The approach is summarized by the flow diagram on the Figure below.</p>

<figure>
<img src="/images/dsm_book/malUncert.png" alt="rconsole" />
<figcaption>
Flow diagram of the general procedure for achieving the outcome of mapping predictions and their uncertainties (upper and lower prediction limits) within a digital soil mapping framework. The 3 components for achieving this outcome are the prediction model, the empirical uncertainty model and the mapping component. Sourced from Malone et al. (2011).
</figcaption>
</figure>

<p>One benefit of using a fuzzy kmeans approach is that the spatial distribution of uncertainty is represented as a continuous variable. Further, the incorporation of extragrades in the fuzzy kmeans classifying provides an explicit means to identify and highlight areas of the greatest uncertainty and possibly where new sampling efforts should be prioritized. As shown in the figure the approach entails 3 main processes:</p>

<ol>
  <li>Calibrating the spatial model</li>
  <li>deriving the uncertainty model which includes both estimations of model errors and fuzzy kmeans with extragrades classification</li>
  <li>Creation of maps of both spatial soil predictions and uncertainties.</li>
</ol>

<p>Naturally, this framework is evaluated using an out-of-bag or better still, independent data set.</p>

<p><a href="#top">Back to top</a></p>

<h3 id="data-preparation-">Data preparation <a id="s-2"></a></h3>

<p>Here we will use a random forest regression kriging model for the prediction of soil pH across the study area. This model will also be incorporated into the uncertainty model via leave-one-out cross validation in order to derive the underlying model errors. As with other examples, we begin by preparing the data.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Libraries </span><span class="w">
</span><span class="c1"># may need to install the fuzme R package</span><span class="w">
</span><span class="c1"># install.packages('devtools') library(devtools)</span><span class="w">
</span><span class="c1"># install_bitbucket('brendo1001/fuzme/rPackage/fuzme')</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">ithir</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">sf</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">terra</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">randomForest</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">gstat</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">fuzme</span><span class="p">)</span><span class="w">

</span><span class="c1"># point data</span><span class="w">
</span><span class="n">data</span><span class="p">(</span><span class="n">HV_subsoilpH</span><span class="p">)</span><span class="w">

</span><span class="c1"># Start afresh round pH data to 2 decimal places</span><span class="w">
</span><span class="n">HV_subsoilpH</span><span class="o">$</span><span class="n">pH60_100cm</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">round</span><span class="p">(</span><span class="n">HV_subsoilpH</span><span class="o">$</span><span class="n">pH60_100cm</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">)</span><span class="w">

</span><span class="c1"># remove already intersected data</span><span class="w">
</span><span class="n">HV_subsoilpH</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">HV_subsoilpH</span><span class="p">[,</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="m">3</span><span class="p">]</span><span class="w">

</span><span class="c1"># add an id column</span><span class="w">
</span><span class="n">HV_subsoilpH</span><span class="o">$</span><span class="n">id</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">seq</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">nrow</span><span class="p">(</span><span class="n">HV_subsoilpH</span><span class="p">),</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w">

</span><span class="c1"># re-arrange order of columns</span><span class="w">
</span><span class="n">HV_subsoilpH</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">HV_subsoilpH</span><span class="p">[,</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">3</span><span class="p">)]</span><span class="w">

</span><span class="c1"># Change names of coordinate columns</span><span class="w">
</span><span class="nf">names</span><span class="p">(</span><span class="n">HV_subsoilpH</span><span class="p">)[</span><span class="m">2</span><span class="o">:</span><span class="m">3</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"x"</span><span class="p">,</span><span class="w"> </span><span class="s2">"y"</span><span class="p">)</span><span class="w">
</span><span class="c1"># save a copy of coordinates</span><span class="w">
</span><span class="n">HV_subsoilpH</span><span class="o">$</span><span class="n">x</span><span class="m">2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">HV_subsoilpH</span><span class="o">$</span><span class="n">x</span><span class="w">
</span><span class="n">HV_subsoilpH</span><span class="o">$</span><span class="n">y</span><span class="m">2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">HV_subsoilpH</span><span class="o">$</span><span class="n">y</span><span class="w">

</span><span class="c1"># convert data to sf object</span><span class="w">
</span><span class="n">HV_subsoilpH</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sf</span><span class="o">::</span><span class="n">st_as_sf</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HV_subsoilpH</span><span class="p">,</span><span class="w"> </span><span class="n">coords</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"x"</span><span class="p">,</span><span class="w"> </span><span class="s2">"y"</span><span class="p">))</span><span class="w">

</span><span class="c1"># grids (covariate rasters from ithir package)</span><span class="w">
</span><span class="n">hv.sub.rasters</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">list.files</span><span class="p">(</span><span class="n">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">system.file</span><span class="p">(</span><span class="s2">"extdata/"</span><span class="p">,</span><span class="w"> </span><span class="n">package</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"ithir"</span><span class="p">),</span><span class="w"> </span><span class="n">pattern</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"hunterCovariates_sub"</span><span class="p">,</span><span class="w">
</span><span class="n">full.names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w">

</span><span class="c1"># read them into R as SpatRaster objects</span><span class="w">
</span><span class="n">hv.sub.rasters</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">terra</span><span class="o">::</span><span class="n">rast</span><span class="p">(</span><span class="n">hv.sub.rasters</span><span class="p">)</span><span class="w">

</span><span class="c1"># extract covariate data</span><span class="w">
</span><span class="n">DSM_data</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">terra</span><span class="o">::</span><span class="n">extract</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hv.sub.rasters</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HV_subsoilpH</span><span class="p">,</span><span class="w"> </span><span class="n">bind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">T</span><span class="p">,</span><span class="w"> </span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"simple"</span><span class="p">)</span><span class="w">
</span><span class="n">DSM_data</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">as.data.frame</span><span class="p">(</span><span class="n">DSM_data</span><span class="p">)</span><span class="w">

</span><span class="c1"># check for NA values</span><span class="w">
</span><span class="n">which</span><span class="p">(</span><span class="o">!</span><span class="n">complete.cases</span><span class="p">(</span><span class="n">DSM_data</span><span class="p">))</span><span class="w">

</span><span class="c1">## integer(0)</span><span class="w">

</span><span class="n">DSM_data</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">DSM_data</span><span class="p">[</span><span class="n">complete.cases</span><span class="p">(</span><span class="n">DSM_data</span><span class="p">),</span><span class="w"> </span><span class="p">]</span><span class="w">

</span><span class="c1"># subset data for modeling</span><span class="w">
</span><span class="n">set.seed</span><span class="p">(</span><span class="m">123</span><span class="p">)</span><span class="w">
</span><span class="n">training</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sample</span><span class="p">(</span><span class="n">nrow</span><span class="p">(</span><span class="n">DSM_data</span><span class="p">),</span><span class="w"> </span><span class="m">0.7</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">nrow</span><span class="p">(</span><span class="n">DSM_data</span><span class="p">))</span><span class="w">
</span><span class="n">DSM_data_cal</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">DSM_data</span><span class="p">[</span><span class="n">training</span><span class="p">,</span><span class="w"> </span><span class="p">]</span><span class="w">
</span><span class="n">DSM_data_val</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">DSM_data</span><span class="p">[</span><span class="o">-</span><span class="n">training</span><span class="p">,</span><span class="w"> </span><span class="p">]</span><span class="w">
</span></code></pre></div></div>

<p><a href="#top">Back to top</a></p>

<h3 id="predictive-model-fitting-">Predictive model fitting <a id="s-3"></a></h3>

<p>Now we fit a random forest model using all possible covariates.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## Model fitting</span><span class="w">
</span><span class="n">hv.RF.Exp</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">randomForest</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DSM_data_cal</span><span class="p">[,</span><span class="w"> </span><span class="m">5</span><span class="o">:</span><span class="m">15</span><span class="p">],</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DSM_data_cal</span><span class="o">$</span><span class="n">pH60_100cm</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DSM_data_cal</span><span class="p">,</span><span class="w"> </span><span class="n">importance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">,</span><span class="w"> </span><span class="n">ntree</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">500</span><span class="p">)</span><span class="w">

</span><span class="c1"># goodness of fit on calibration data</span><span class="w">
</span><span class="n">goof</span><span class="p">(</span><span class="n">observed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DSM_data_cal</span><span class="o">$</span><span class="n">pH60_100cm</span><span class="p">,</span><span class="w"> </span><span class="n">predicted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">predict</span><span class="p">(</span><span class="n">hv.RF.Exp</span><span class="p">,</span><span class="w"> </span><span class="n">newdata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DSM_data_cal</span><span class="p">),</span><span class="w"> </span><span class="n">plot.it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span><span class="w">

</span><span class="c1">##          R2 concordance       MSE      RMSE        bias</span><span class="w">
</span><span class="c1">## 1 0.9230237   0.8855885 0.2841076 0.5330174 0.004619073</span><span class="w">
</span></code></pre></div></div>

<p>The <code class="highlighter-rouge">hv.RF.Exp</code> model appears to perform quite well when we examine the goodness of fit statistics.</p>

<p>Now we can examine the model residuals for any presence of spatial structure with variogram modeling. For the output below it does seems that there is some useful correlation structure in the residuals that will likely help to improve upon the performance of the <code class="highlighter-rouge">hv.RF.Exp</code>
model.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># calculate the residual</span><span class="w">
</span><span class="n">DSM_data_cal</span><span class="o">$</span><span class="n">residual</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">DSM_data_cal</span><span class="o">$</span><span class="n">pH60_100cm</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">predict</span><span class="p">(</span><span class="n">hv.RF.Exp</span><span class="p">,</span><span class="w"> </span><span class="n">newdata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DSM_data_cal</span><span class="p">)</span><span class="w">

</span><span class="c1"># calculate empirical variogram of residuals</span><span class="w">
</span><span class="nf">names</span><span class="p">(</span><span class="n">DSM_data_cal</span><span class="p">)[</span><span class="m">3</span><span class="o">:</span><span class="m">4</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"x"</span><span class="p">,</span><span class="w"> </span><span class="s2">"y"</span><span class="p">)</span><span class="w">
</span><span class="n">vgm1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">variogram</span><span class="p">(</span><span class="n">residual</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="o">~</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DSM_data_cal</span><span class="p">,</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">200</span><span class="p">,</span><span class="w"> </span><span class="n">cutoff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3000</span><span class="p">)</span><span class="w">

</span><span class="c1"># initialise variogram model parameters</span><span class="w">
</span><span class="n">mod</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">vgm</span><span class="p">(</span><span class="n">psill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">var</span><span class="p">(</span><span class="n">DSM_data_cal</span><span class="o">$</span><span class="n">residual</span><span class="p">),</span><span class="w"> </span><span class="s2">"Sph"</span><span class="p">,</span><span class="w">  </span><span class="n">range</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3000</span><span class="p">,</span><span class="w"> </span><span class="n">nugget</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w">

</span><span class="c1"># fit variogram model</span><span class="w">
</span><span class="n">model_1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">fit.variogram</span><span class="p">(</span><span class="n">vgm1</span><span class="p">,</span><span class="w"> </span><span class="n">mod</span><span class="p">)</span><span class="w">
</span><span class="n">model_1</span><span class="w">

</span><span class="c1">##   model     psill    range</span><span class="w">
</span><span class="c1">## 1   Nug 0.2000183    0.000</span><span class="w">
</span><span class="c1">## 2   Sph 0.0985494 1233.341</span><span class="w">

</span><span class="c1"># variogram object</span><span class="w">
</span><span class="n">gR</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">gstat</span><span class="p">(</span><span class="kc">NULL</span><span class="p">,</span><span class="w"> </span><span class="s2">"hunterpH_residual_RF"</span><span class="p">,</span><span class="w"> </span><span class="n">residual</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DSM_data_cal</span><span class="p">,</span><span class="w"> </span><span class="n">locations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">~</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">model_1</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p><a href="#top">Back to top</a></p>

<h3 id="estimating-underlying-model-errors-">Estimating underlying model errors <a id="s-4"></a></h3>

<p>We now need to estimate the model errors and a good way to do this is via the LOCV approach. <a href="/DSM_book/data/uncerts/hunter_DSMDat.csv">To save time and get more quickly through the exercise the data out from below can be downloaded here.</a></p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## LEAVE - ONE - OUT - CROSS - VALIDATION estimation of empirical model</span><span class="w">
</span><span class="c1">## residuals Note: the following step could take a little time to compute.</span><span class="w">
</span><span class="c1">## This data can be loaded to avoid the following step of LOCV Just get your</span><span class="w">
</span><span class="c1">## file paths right looResidualdata DSM_data_cal&lt;-</span><span class="w">
</span><span class="c1">## read.csv(file='hunter_DSMDat.csv') End note</span><span class="w">

</span><span class="c1"># placeholder for cv residuals</span><span class="w">
</span><span class="n">DSM_data_cal</span><span class="o">$</span><span class="n">looResiduals</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="kc">NA</span><span class="w">

</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="n">nrow</span><span class="p">(</span><span class="n">DSM_data_cal</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="c1"># subset model frame</span><span class="w">
  </span><span class="n">sub.frame</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">DSM_data_cal</span><span class="p">[</span><span class="o">-</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="p">]</span><span class="w">
  </span><span class="c1"># fit model</span><span class="w">
  </span><span class="n">looRFPred</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">randomForest</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sub.frame</span><span class="p">[,</span><span class="w"> </span><span class="m">5</span><span class="o">:</span><span class="m">15</span><span class="p">],</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sub.frame</span><span class="o">$</span><span class="n">pH60_100cm</span><span class="p">,</span><span class="w"> </span><span class="n">importance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">,</span><span class="w"> </span><span class="n">ntree</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">500</span><span class="p">)</span><span class="w">
  </span><span class="n">rf.preds</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">predict</span><span class="p">(</span><span class="n">looRFPred</span><span class="p">,</span><span class="w"> </span><span class="n">newdata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sub.frame</span><span class="p">[,</span><span class="w"> </span><span class="m">5</span><span class="o">:</span><span class="m">15</span><span class="p">])</span><span class="w">
  </span><span class="n">sub.frame</span><span class="o">$</span><span class="n">locv_resid</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sub.frame</span><span class="o">$</span><span class="n">pH60_100cm</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">rf.preds</span><span class="w">
  </span><span class="c1"># residual variogram</span><span class="w">
  </span><span class="n">vgm.locv</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">variogram</span><span class="p">(</span><span class="n">locv_resid</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="o">~</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sub.frame</span><span class="p">,</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">200</span><span class="p">,</span><span class="w"> </span><span class="n">cutoff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3000</span><span class="p">)</span><span class="w">
  </span><span class="n">mod.locv</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">vgm</span><span class="p">(</span><span class="n">psill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">var</span><span class="p">(</span><span class="n">sub.frame</span><span class="o">$</span><span class="n">locv_resid</span><span class="p">),</span><span class="w"> </span><span class="s2">"Sph"</span><span class="p">,</span><span class="w"> </span><span class="n">range</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3000</span><span class="p">,</span><span class="w"> </span><span class="n">nugget</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w">
  </span><span class="n">model.locv</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">fit.variogram</span><span class="p">(</span><span class="n">vgm.locv</span><span class="p">,</span><span class="w"> </span><span class="n">mod.locv</span><span class="p">)</span><span class="w">
  </span><span class="c1"># interpolate residual</span><span class="w">
  </span><span class="n">int.resids</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">krige</span><span class="p">(</span><span class="n">locv_resid</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">locations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">~</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sub.frame</span><span class="p">,</span><span class="w"> </span><span class="n">newdata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DSM_data_cal</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="p">],</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">model.locv</span><span class="p">,</span><span class="w"> </span><span class="n">debug.level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">)[</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">3</span><span class="p">]</span><span class="w">
  </span><span class="n">looPred</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">predict</span><span class="p">(</span><span class="n">object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">looRFPred</span><span class="p">,</span><span class="w"> </span><span class="n">newdata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DSM_data_cal</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="m">5</span><span class="o">:</span><span class="m">15</span><span class="p">])</span><span class="w">
  </span><span class="n">DSM_data_cal</span><span class="o">$</span><span class="n">looResiduals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">DSM_data_cal</span><span class="o">$</span><span class="n">pH60_100cm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">looPred</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">int.resids</span><span class="p">)</span><span class="w">
  </span><span class="n">print</span><span class="p">(</span><span class="n">nrow</span><span class="p">(</span><span class="n">DSM_data_cal</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">i</span><span class="p">)}</span><span class="w">
</span></code></pre></div></div>

<p><a href="#top">Back to top</a></p>

<h3 id="fuzzy-clustering-with-extragrades-">Fuzzy clustering with extragrades <a id="s-5"></a></h3>

<p><a href="#s-11">Jump to code</a></p>

<p>The defining aspect of this uncertainty approach is fuzzy clustering with extragrades. McBratney and Gruijter (1992) recognized a limitation of the normal fuzzy clustering algorithm in that it had an inability to distinguish between observations very far from the cluster centroids and those at the centre of the centroid configuration. These observations were termed extragrades as opposed to intragrades, which are the observations that lie between the main clusters. The extragrades are considered the outliers of the data set and have a distorting influence on the configuration of the main clusters (Lagacherie et al. 1997). McBratney and Gruijter (1992) developed an adaptation to the FKM
algorithm which distinguishes observations that should belong to an extragrade cluster. The FKM with extragrades algorithm minimizes the objective function:</p>

<p><img src="https://latex.codecogs.com/svg.image?J_{e}(\textbf{C},\textbf{M})=\alpha\sum_{i=1}^n\sum_{j=1}^c&space;m_{ij}^\psi&space;d_{ij}^2&plus;(1-\alpha)\sum_{i=1}^nm_{i^{\star}}^\psi\sum_{i=1}^nd_{ij}^-2" alt="fuzzy objective function" /></p>

<p>where <strong>C</strong> is the <em>c</em> × <em>p</em> matrix of cluster centers where <em>c</em> is the cluster and <em>p</em> is the number of variables. <strong>M</strong> is the <em>n</em> × <em>c</em> matrix of partial memberships, where <em>n</em> is the number of observations;
<em>m</em><sub><em>ij</em></sub><em>ϵ</em> is the partial membership of the <em>i</em>th observation to the <em>j</em>th cluster. <em>ψ</em> ≥ 1 is the fuzziness exponent. The square distance between the <em>i</em>th observation to the <em>j</em>th cluster is <em>d</em><sub><em>ij</em></sub><sup>2</sup>. <em>m</em><sub><em>i</em><sup>⋆</sup></sub><sup><em>ψ</em></sup> denotes the membership to the extragrade cluster. This function also requires the parameter alpha (<em>α</em>) to be defined, which is used to evaluate membership to the extragrade cluster.</p>

<p>A very good stand-alone software developed by Minasny (2002) called <code class="highlighter-rouge">Fuzme</code> contains the FKM with extragrades method, plus other clustering methods. The software may be downloaded for free from <a href="https://precision-agriculture.sydney.edu.au/resources/software/">here</a>.</p>

<p>The source script to this software has also been written to an <code class="highlighter-rouge">R</code> package of the same name.</p>

<p>Normally, the stand-alone software would be used because it is computationally much faster. However, using the <code class="highlighter-rouge">fuzme</code> package allows one to easily integrate the clustering procedures into a standard <code class="highlighter-rouge">R</code> workflow. For example, one of the issues of clustering procedures is the uncertainty regarding the selection of an optimal cluster number for a given data set.</p>

<p>There are a number of ways to determine an optimal solution. Some popular approaches include to determining the cluster combination which minimizes the Fuzzy Performance Index (FPI) or Modified partition Entropy (MPE). The MPE establishes the degree of fuzziness created by a specified number of clusters for a defined exponent value. The notion is that the smaller the MPE, the more suitable is the corresponding number of clusters at the given exponent value. A more sophisticated analysis is to look at the derivative of <em>J</em><sub><em>e</em></sub>(<strong>C</strong>,<strong>M</strong>) with respect to <em>ψ</em> and is used to simultaneously establish the optimal <em>ψ</em> and cluster size. More is discussed about each of these indices by Odeh et al. (1992) and Bragato (2004).</p>

<p>The key generally is to define clusters which can be easily distinguished compared to a collection of clusters that are all quite similar. Such diagnostic criteria are useful; however it would be more beneficial to determine an optimal cluster configuration based on criteria that are meaningful to the current situation of deriving prediction uncertainties.</p>

<p>In this case we might want to evaluate the optimal cluster number <em>and</em> fuzzy exponent that maximizes the fidelity of PICP to confidence interval, and minimizes the prediction interval range. The idea here is to determine an optimal cluster number and fuzzy exponent based on criteria related to prediction interval width and PICP, together with some of the other fuzzy clustering criteria.</p>

<p>Optimization of the fuzzy classification parameters is no simple computational task and requires something akin the a grid search to find the best configuration setting whichever method is used.</p>

<p>The example below runs with a set of parameters that have been somewhat optimized offline. For you own data sets the optimization while time consuming is a necessary requirement of using this type of uncertainty quantification approach.</p>

<p>We essentially want to perform fuzzy clustering with extragrades upon the environmental covariate of the data points in the <code class="highlighter-rouge">DSM_data_cal</code> object. Fuzzy clustering with extragrades is implemented via a two-step procedure using the <code class="highlighter-rouge">fobjk</code> and <code class="highlighter-rouge">fkme</code> functions from the <code class="highlighter-rouge">fuzme</code> package.</p>

<p>The <code class="highlighter-rouge">fobjk</code>function allows one to find an optimal solution for alpha (<em>α</em>) which is the parameter that allows one to control the membership of data to the extragrade cluster. For example, if we wanted to stipulate that we want the average extragrade membership of a data set to be 10%, then we need to find an optimal solution for alpha to achieve that outcome. This can be controlled through the <code class="highlighter-rouge">Uereq</code> parameter of the <code class="highlighter-rouge">fobjk</code> function.</p>

<p>Now we need to prepare the data for clustering, and parameterize the other inputs of the function. The other inputs are: <code class="highlighter-rouge">nclass</code>, which is the number of clusters you want to define. Note that an extra cluster will be defined as this will be the extragrade cluster and the associated memberships. <code class="highlighter-rouge">data</code> is the data needed for clustering, <code class="highlighter-rouge">U</code> is an initial membership matrix in order to get the fuzzy clustering algorithm operable. <code class="highlighter-rouge">phi</code> is the fuzzy exponent, while <code class="highlighter-rouge">distype</code> refers to the distance metric to be used for clustering. There are 3 possible distance metrics available. These are: Euclidean (1), Diagonal (2), and Mahalanobis (3).</p>

<p>As an example of using the <code class="highlighter-rouge">fobjk</code> lets define 4 clusters with a fuzzy exponent of 1.2, and with the average extragrade membership of 10%. Currently this function is pretty slow to compute the optimal alpha, so be prepared to wait a while. Alternatively, <a href="https://precision-agriculture.sydney.edu.au/resources/software/">the standalone <code class="highlighter-rouge">Fuzme</code> software described earlier</a> makes this task more efficient. <a id="s-11"></a></p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## FUZZY KMEANS with EXTRAGRADES Computation of optimal alfa value used for FKM</span><span class="w">
</span><span class="c1">## with extragrades Note: the following step could take a little time to compute.  End Note</span><span class="w">

</span><span class="n">data.t</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">DSM_data_cal</span><span class="p">[,</span><span class="w"> </span><span class="m">5</span><span class="o">:</span><span class="m">15</span><span class="p">]</span><span class="w">  </span><span class="c1"># data to be clustered</span><span class="w">
</span><span class="n">nclass.t</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">4</span><span class="w">  </span><span class="c1"># number of clusters</span><span class="w">
</span><span class="n">phi.t</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">1.2</span><span class="w">  </span><span class="c1"># fuzzy exponent</span><span class="w">
</span><span class="n">distype.t</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">3</span><span class="w">  </span><span class="c1"># 3 = Mahalanobis distance</span><span class="w">
</span><span class="n">Uereq.t</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">0.1</span><span class="w">  </span><span class="c1"># average extragrade membership</span><span class="w">

</span><span class="c1"># initial membership matrix</span><span class="w">
</span><span class="n">scatter.t</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">0.2</span><span class="w">  </span><span class="c1"># scatter around initial membership</span><span class="w">
</span><span class="n">ndata.t</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">dim</span><span class="p">(</span><span class="n">data.t</span><span class="p">)[</span><span class="m">1</span><span class="p">]</span><span class="w">
</span><span class="n">U.t</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">fuzme</span><span class="o">::</span><span class="n">initmember</span><span class="p">(</span><span class="n">scatter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">scatter.t</span><span class="p">,</span><span class="w"> </span><span class="n">nclass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nclass.t</span><span class="p">,</span><span class="w"> </span><span class="n">ndata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ndata.t</span><span class="p">)</span><span class="w">

</span><span class="c1"># run fuzzy objective function</span><span class="w">
</span><span class="n">alfa.t</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">fuzme</span><span class="o">::</span><span class="n">fobjk</span><span class="p">(</span><span class="n">Uereq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Uereq.t</span><span class="p">,</span><span class="w"> </span><span class="n">nclass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nclass.t</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data.t</span><span class="p">,</span><span class="w"> </span><span class="n">U</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">U.t</span><span class="p">,</span><span class="w">
</span><span class="n">phi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">phi.t</span><span class="p">,</span><span class="w"> </span><span class="n">distype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">distype.t</span><span class="p">)</span><span class="w">
</span><span class="n">alfa.t</span><span class="w">
</span></code></pre></div></div>

<p>Remember the <code class="highlighter-rouge">fobjk</code> function will only return the optimal alfa value which in this particular case was <code class="highlighter-rouge">0.01136809</code>. This value then gets inserted into the associated <code class="highlighter-rouge">fkme</code> function in order to estimate the memberships of the data to each cluster and the extragrade cluster. The <code class="highlighter-rouge">fkme</code> function also returns the cluster centroids too which are critical to the work need for allocation of memberships to new data cases.</p>

<p>The <code class="highlighter-rouge">fkme</code> function is parameterized similarly to <code class="highlighter-rouge">fobjk</code>, yet with some additional inputs related to the number of allowable iterations for convergence (<code class="highlighter-rouge">maxiter</code>), the convergence criterion value (<code class="highlighter-rouge">toldif</code>), and whether or not to display behind-the-scenes processing.</p>

<p>While the below is useful to watch as it works to minimise the objective function, it does require some time to converge. <a href="/DSM_book/data/uncerts/fkme_example_out.rds">If needed you can avoid this step and load directly the expected output from below.</a></p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## FKM with extragrade Note: the following step could take a little time to</span><span class="w">
</span><span class="c1">## compute.  This data can be loaded to avoid the following step of FKM with</span><span class="w">
</span><span class="c1">## extragrade Just get your file paths right readRDS(file =</span><span class="w">
</span><span class="c1">## 'fkme_example_out.rds') [download link] End Note</span><span class="w">

</span><span class="n">alfa.t</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">0.01136809</span><span class="w">
</span><span class="n">tester</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">fkme</span><span class="p">(</span><span class="n">nclass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nclass.t</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data.t</span><span class="p">,</span><span class="w"> </span><span class="n">U</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">U.t</span><span class="p">,</span><span class="w"> </span><span class="n">phi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">phi.t</span><span class="p">,</span><span class="w"> </span><span class="n">alfa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">alfa.t</span><span class="p">,</span><span class="w">
</span><span class="n">maxiter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">500</span><span class="p">,</span><span class="w"> </span><span class="n">distype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">distype.t</span><span class="p">,</span><span class="w"> </span><span class="n">toldif</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.01</span><span class="p">,</span><span class="w"> </span><span class="n">verbose</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>The <code class="highlighter-rouge">fkme</code> function returns a list with a number of elements. At this stage we are primarily interested in the elements <code class="highlighter-rouge">membership</code> and <code class="highlighter-rouge">centroid</code> which we will use a little later on.</p>

<p>As described earlier, there are a number of criteria to assess the validity of a particular clustering configuration. We can evaluate these by using the <code class="highlighter-rouge">fvalidity</code> function. It essentially takes in a few of the outputs from the <code class="highlighter-rouge">fkme</code> function.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## Fuzzy performance indices</span><span class="w">
</span><span class="n">fuzme</span><span class="o">::</span><span class="n">fvalidity</span><span class="p">(</span><span class="n">U</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tester</span><span class="o">$</span><span class="n">membership</span><span class="p">[,</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="m">4</span><span class="p">],</span><span class="w"> 
</span><span class="n">dist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tester</span><span class="o">$</span><span class="n">distance</span><span class="p">,</span><span class="w"> 
</span><span class="n">centroid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tester</span><span class="o">$</span><span class="n">centroid</span><span class="p">,</span><span class="w">
</span><span class="n">nclass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4</span><span class="p">,</span><span class="w"> 
</span><span class="n">phi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1.2</span><span class="p">,</span><span class="w"> 
</span><span class="n">W</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tester</span><span class="o">$</span><span class="n">distNormMat</span><span class="p">)</span><span class="w">

</span><span class="c1">##         fpi       mpe         S   dJ/dphi</span><span class="w">
</span><span class="c1">## 1 0.5186971 0.4136468 0.9024766 -1808.337</span><span class="w">
</span></code></pre></div></div>

<p>Another useful metric is the confusion index (after Burrough et al. (1997)) which in our case looks at the similarity between the highest and second highest cluster memberships. The confusion index is estimated for each data point. Taking the average over the data set provides some sense of whether cluster can be distinguished from each other.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## Confusion index</span><span class="w">
</span><span class="n">mean</span><span class="p">(</span><span class="n">confusion</span><span class="p">(</span><span class="n">nclass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">5</span><span class="p">,</span><span class="w"> </span><span class="n">U</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tester</span><span class="o">$</span><span class="n">membership</span><span class="p">))</span><span class="w">

</span><span class="c1">## [1] 0.3499941</span><span class="w">


</span><span class="c1"># Note number of cluster is set to 5 to account for the Additional extragrade cluster.</span><span class="w">
</span></code></pre></div></div>

<p>We now need to assign each data point a one of the clusters we have derived. The assignment is based on the cluster which has the highest membership grade.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## Assign class for each point</span><span class="w">
</span><span class="n">membs</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">as.data.frame</span><span class="p">(</span><span class="n">tester</span><span class="o">$</span><span class="n">membership</span><span class="p">)</span><span class="w">
</span><span class="n">membs</span><span class="o">$</span><span class="n">class</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="kc">NA</span><span class="w">
</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="n">nrow</span><span class="p">(</span><span class="n">membs</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="n">mbs2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">membs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="n">ncol</span><span class="p">(</span><span class="n">tester</span><span class="o">$</span><span class="n">membership</span><span class="p">)]</span><span class="w">
  </span><span class="c1"># which is the maximum probability on this row</span><span class="w">
  </span><span class="n">membs</span><span class="o">$</span><span class="n">class</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">which</span><span class="p">(</span><span class="n">mbs2</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nf">max</span><span class="p">(</span><span class="n">mbs2</span><span class="p">))[</span><span class="m">1</span><span class="p">]}</span><span class="w">

</span><span class="n">membs</span><span class="o">$</span><span class="n">class</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">as.factor</span><span class="p">(</span><span class="n">membs</span><span class="o">$</span><span class="n">class</span><span class="p">)</span><span class="w">
</span><span class="n">summary</span><span class="p">(</span><span class="n">membs</span><span class="o">$</span><span class="n">class</span><span class="p">)</span><span class="w">

</span><span class="c1">##  1  2  3  4  5 </span><span class="w">
</span><span class="c1">## 96 75 58 87 38</span><span class="w">

</span><span class="c1"># combine with main data frame that cotain LOCV model residuals</span><span class="w">
</span><span class="n">DSM_data_cal</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">cbind</span><span class="p">(</span><span class="n">DSM_data_cal</span><span class="p">,</span><span class="w"> </span><span class="n">membs</span><span class="o">$</span><span class="n">class</span><span class="p">)</span><span class="w">
</span><span class="nf">names</span><span class="p">(</span><span class="n">DSM_data_cal</span><span class="p">)[</span><span class="n">ncol</span><span class="p">(</span><span class="n">DSM_data_cal</span><span class="p">)]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s2">"class"</span><span class="w">
</span></code></pre></div></div>

<p>Then we derive the cluster model error. This entails splitting the <code class="highlighter-rouge">DSM_data_cal</code> object up on the basis of the cluster with the highest membership i.e. <code class="highlighter-rouge">DSM_data_cal$class</code>.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## QUANTILES OF RESIDUALS IN EACH CLASS FOR CLASS PREDICTION LIMITS</span><span class="w">
</span><span class="n">DSM_data_cal.split</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">split</span><span class="p">(</span><span class="n">DSM_data_cal</span><span class="p">,</span><span class="w"> </span><span class="n">DSM_data_cal</span><span class="o">$</span><span class="n">class</span><span class="p">)</span><span class="w">

</span><span class="c1"># cluster lower prediction limits</span><span class="w">
</span><span class="n">quanMat1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">matrix</span><span class="p">(</span><span class="kc">NA</span><span class="p">,</span><span class="w"> </span><span class="n">ncol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">10</span><span class="p">,</span><span class="w"> </span><span class="n">nrow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="n">DSM_data_cal.split</span><span class="p">))</span><span class="w">
</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="nf">length</span><span class="p">(</span><span class="n">DSM_data_cal.split</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="n">quanMat1</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">quantile</span><span class="p">(</span><span class="n">DSM_data_cal.split</span><span class="p">[[</span><span class="n">i</span><span class="p">]][,</span><span class="w"> </span><span class="s2">"looResiduals"</span><span class="p">],</span><span class="w"> </span><span class="n">probs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">0.005</span><span class="p">,</span><span class="w"> </span><span class="m">0.0125</span><span class="p">,</span><span class="w"> </span><span class="m">0.025</span><span class="p">,</span><span class="w"> </span><span class="m">0.05</span><span class="p">,</span><span class="w"> </span><span class="m">0.1</span><span class="p">,</span><span class="w"> </span><span class="m">0.2</span><span class="p">,</span><span class="w"> </span><span class="m">0.3</span><span class="p">,</span><span class="w"> </span><span class="m">0.4</span><span class="p">,</span><span class="w"> </span><span class="m">0.45</span><span class="p">,</span><span class="w"> </span><span class="m">0.475</span><span class="p">),</span><span class="w"> </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">,</span><span class="w"> </span><span class="n">names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">F</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">7</span><span class="p">)}</span><span class="w">

</span><span class="n">row.names</span><span class="p">(</span><span class="n">quanMat1</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">levels</span><span class="p">(</span><span class="n">DSM_data_cal</span><span class="o">$</span><span class="n">class</span><span class="p">)</span><span class="w">
</span><span class="n">quanMat1</span><span class="p">[</span><span class="n">nrow</span><span class="p">(</span><span class="n">quanMat1</span><span class="p">),</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">quanMat1</span><span class="p">[</span><span class="n">nrow</span><span class="p">(</span><span class="n">quanMat1</span><span class="p">),</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">2</span><span class="w">
</span><span class="n">quanMat1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">t</span><span class="p">(</span><span class="n">quanMat1</span><span class="p">)</span><span class="w">
</span><span class="n">row.names</span><span class="p">(</span><span class="n">quanMat1</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">99</span><span class="p">,</span><span class="w"> </span><span class="m">97.5</span><span class="p">,</span><span class="w"> </span><span class="m">95</span><span class="p">,</span><span class="w"> </span><span class="m">90</span><span class="p">,</span><span class="w"> </span><span class="m">80</span><span class="p">,</span><span class="w"> </span><span class="m">60</span><span class="p">,</span><span class="w"> </span><span class="m">40</span><span class="p">,</span><span class="w"> </span><span class="m">20</span><span class="p">,</span><span class="w"> </span><span class="m">10</span><span class="p">,</span><span class="w"> </span><span class="m">5</span><span class="p">)</span><span class="w">

</span><span class="c1"># cluster upper prediction limits</span><span class="w">
</span><span class="n">quanMat2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">matrix</span><span class="p">(</span><span class="kc">NA</span><span class="p">,</span><span class="w"> </span><span class="n">ncol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">10</span><span class="p">,</span><span class="w"> </span><span class="n">nrow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="n">DSM_data_cal.split</span><span class="p">))</span><span class="w">
</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="nf">length</span><span class="p">(</span><span class="n">DSM_data_cal.split</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="n">quanMat2</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">quantile</span><span class="p">(</span><span class="n">DSM_data_cal.split</span><span class="p">[[</span><span class="n">i</span><span class="p">]][,</span><span class="w"> </span><span class="s2">"looResiduals"</span><span class="p">],</span><span class="w"> </span><span class="n">probs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">0.995</span><span class="p">,</span><span class="w"> </span><span class="m">0.9875</span><span class="p">,</span><span class="w"> </span><span class="m">0.975</span><span class="p">,</span><span class="w"> </span><span class="m">0.95</span><span class="p">,</span><span class="w"> </span><span class="m">0.9</span><span class="p">,</span><span class="w"> </span><span class="m">0.8</span><span class="p">,</span><span class="w"> </span><span class="m">0.7</span><span class="p">,</span><span class="w"> </span><span class="m">0.6</span><span class="p">,</span><span class="w"> </span><span class="m">0.55</span><span class="p">,</span><span class="w"> </span><span class="m">0.525</span><span class="p">),</span><span class="w"> </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">,</span><span class="w"> </span><span class="n">names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">F</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">7</span><span class="p">)}</span><span class="w">
  
</span><span class="n">quanMat2</span><span class="p">[</span><span class="n">quanMat2</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">0</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">0</span><span class="w">
</span><span class="n">row.names</span><span class="p">(</span><span class="n">quanMat2</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">levels</span><span class="p">(</span><span class="n">DSM_data_cal</span><span class="o">$</span><span class="n">class</span><span class="p">)</span><span class="w">
</span><span class="n">quanMat2</span><span class="p">[</span><span class="n">nrow</span><span class="p">(</span><span class="n">quanMat2</span><span class="p">),</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">quanMat2</span><span class="p">[</span><span class="n">nrow</span><span class="p">(</span><span class="n">quanMat2</span><span class="p">),</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">2</span><span class="w">
</span><span class="n">quanMat2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">t</span><span class="p">(</span><span class="n">quanMat2</span><span class="p">)</span><span class="w">
</span><span class="n">row.names</span><span class="p">(</span><span class="n">quanMat2</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">99</span><span class="p">,</span><span class="w"> </span><span class="m">97.5</span><span class="p">,</span><span class="w"> </span><span class="m">95</span><span class="p">,</span><span class="w"> </span><span class="m">90</span><span class="p">,</span><span class="w"> </span><span class="m">80</span><span class="p">,</span><span class="w"> </span><span class="m">60</span><span class="p">,</span><span class="w"> </span><span class="m">40</span><span class="p">,</span><span class="w"> </span><span class="m">20</span><span class="p">,</span><span class="w"> </span><span class="m">10</span><span class="p">,</span><span class="w"> </span><span class="m">5</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>The objects <code class="highlighter-rouge">quanMat1</code> and <code class="highlighter-rouge">quanMat2</code> represent the  lower and upper model errors for each cluster for each quantile respectively.</p>

<p>For the extragrade cluster, we multiple the error by a constant, here 2, in order to explicitly indicate that the extragrade cluster (being outliers of the data) have a higher uncertainty.</p>

<p><a href="#top">Back to top</a></p>

<h3 id="evaluating-the-quantification-of-uncertainties-">Evaluating the quantification of uncertainties <a id="s-6"></a></h3>

<p>Using the out-of-bag data, we need evaluate the PICP and prediction interval width. This requires first allocating cluster memberships to the points on the basis of outputs from using the <code class="highlighter-rouge">fkme</code> function, then using these together with the cluster prediction limits to evaluate weighted averages of the prediction limits for each point. With that done we can then derive the unique upper and lower prediction interval limits for each point at each confidence level.</p>

<p>First, for the membership allocation, we use the <code class="highlighter-rouge">fuzExall</code> function. Essentially this function takes in outputs from the <code class="highlighter-rouge">fkme</code> function and in our case, specifically that concerning the <code class="highlighter-rouge">tester</code> object. Recall that the out-of-bag data is saved to the <code class="highlighter-rouge">DSM_data_val</code> object.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## Evaluation of predictions and uncertainties with out of bag data covariates</span><span class="w">
</span><span class="c1">## of the out-of-bag data</span><span class="w">
</span><span class="n">vCovs</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">DSM_data_val</span><span class="p">[,</span><span class="w"> </span><span class="m">5</span><span class="o">:</span><span class="m">15</span><span class="p">]</span><span class="w">

</span><span class="c1"># run fkme allocation function</span><span class="w">
</span><span class="n">fuzAll</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">fuzme</span><span class="o">::</span><span class="n">fuzExall</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vCovs</span><span class="p">,</span><span class="w"> 
</span><span class="n">phi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1.2</span><span class="p">,</span><span class="w"> 
</span><span class="n">centroid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tester</span><span class="o">$</span><span class="n">centroid</span><span class="p">,</span><span class="w"> 
</span><span class="n">distype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3</span><span class="p">,</span><span class="w">
</span><span class="n">W</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tester</span><span class="o">$</span><span class="n">distNormMat</span><span class="p">,</span><span class="w"> 
</span><span class="n">alfa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tester</span><span class="o">$</span><span class="n">alfa</span><span class="p">)</span><span class="w">

</span><span class="c1"># Get the memberships</span><span class="w">
</span><span class="n">fuz.me</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">fuzAll</span><span class="o">$</span><span class="n">membership</span><span class="w">
</span></code></pre></div></div>

<p>A “fuzzy committee” approach is used to estimate the underlying residual at each point. In this case the upper and lower limits are derived by weighted mean of the lower and upper model errors of each cluster, where the weights are the cluster memberships. This can be defined mathematically as:</p>

<p><img src="https://latex.codecogs.com/svg.image?PI_i^L=\sum_{j=1}^c&space;m_{ij}PIC_j^L" alt="PIL" /></p>

<p><img src="https://latex.codecogs.com/svg.image?PI_i^U=\sum_{j=1}^c&space;m_{ij}PIC_j^U" alt="PIU" /></p>

<p>where <em>PI</em><sub><em>i</em></sub><sup><em>L</em></sup> and
<em>PI</em><sub><em>i</em></sub><sup><em>U</em></sup> correspond to the weighted lower and upper limits for the <em>i</em> th observation. <em>PIC</em><sub><em>j</em></sub><sup><em>L</em></sup> and <em>PIC</em><sub><em>j</em></sub><sup><em>U</em></sup> are the lower and upper limits for each cluster <em>j</em>, and <em>m</em><sub><em>ij</em></sub> is the membership grade of the <em>i</em>th observation to cluster <em>j</em> (which were derived in the previous step). In <code class="highlighter-rouge">R</code>, this can be interpreted as:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># lower prediction limit</span><span class="w">
</span><span class="n">lPI.mat</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">matrix</span><span class="p">(</span><span class="kc">NA</span><span class="p">,</span><span class="w"> </span><span class="n">nrow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nrow</span><span class="p">(</span><span class="n">fuz.me</span><span class="p">),</span><span class="w"> </span><span class="n">ncol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">10</span><span class="p">)</span><span class="w">
</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="n">nrow</span><span class="p">(</span><span class="n">lPI.mat</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">j</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="n">nrow</span><span class="p">(</span><span class="n">quanMat1</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="n">lPI.mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">fuz.me</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="n">ncol</span><span class="p">(</span><span class="n">fuz.me</span><span class="p">)]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">quanMat1</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="p">])}}</span><span class="w">

</span><span class="c1"># upper prediction limit</span><span class="w">
</span><span class="n">uPI.mat</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">matrix</span><span class="p">(</span><span class="kc">NA</span><span class="p">,</span><span class="w"> </span><span class="n">nrow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nrow</span><span class="p">(</span><span class="n">fuz.me</span><span class="p">),</span><span class="w"> </span><span class="n">ncol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">10</span><span class="p">)</span><span class="w">
</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="n">nrow</span><span class="p">(</span><span class="n">uPI.mat</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">j</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="n">nrow</span><span class="p">(</span><span class="n">quanMat2</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="n">uPI.mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">fuz.me</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="n">ncol</span><span class="p">(</span><span class="n">fuz.me</span><span class="p">)]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">quanMat2</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="p">])}}</span><span class="w">
</span></code></pre></div></div>

<p>Then we want to add these values to the actual regression kriging predictions.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Regression kriging predictions for out-of-bag data</span><span class="w">
</span><span class="nf">names</span><span class="p">(</span><span class="n">DSM_data_val</span><span class="p">)[</span><span class="m">3</span><span class="o">:</span><span class="m">4</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"x"</span><span class="p">,</span><span class="w"> </span><span class="s2">"y"</span><span class="p">)</span><span class="w">
</span><span class="n">DSM_data_val</span><span class="o">$</span><span class="n">rf_preds</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">predict</span><span class="p">(</span><span class="n">object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hv.RF.Exp</span><span class="p">,</span><span class="w"> </span><span class="n">newdata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DSM_data_val</span><span class="p">[,</span><span class="w"> </span><span class="m">5</span><span class="o">:</span><span class="m">15</span><span class="p">])</span><span class="w">
</span><span class="n">DSM_data_val</span><span class="o">$</span><span class="n">krig_res</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">krige</span><span class="p">(</span><span class="n">residual</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DSM_data_cal</span><span class="p">,</span><span class="w"> </span><span class="n">locations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">~</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">model_1</span><span class="p">,</span><span class="w"> </span><span class="n">newdata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DSM_data_val</span><span class="p">)[,</span><span class="w"> </span><span class="m">3</span><span class="p">]</span><span class="w">

</span><span class="n">DSM_data_val</span><span class="o">$</span><span class="n">RK_preds</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">DSM_data_val</span><span class="o">$</span><span class="n">rf_preds</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">DSM_data_val</span><span class="o">$</span><span class="n">krig_res</span><span class="w">

</span><span class="c1"># evaluation of model goodness of fit</span><span class="w">
</span><span class="n">goof</span><span class="p">(</span><span class="n">observed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DSM_data_val</span><span class="o">$</span><span class="n">pH60_100cm</span><span class="p">,</span><span class="w"> </span><span class="n">predicted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DSM_data_val</span><span class="o">$</span><span class="n">RK_preds</span><span class="p">,</span><span class="w"> </span><span class="n">plot.it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span><span class="w">

</span><span class="c1">##          R2 concordance      MSE    RMSE       bias</span><span class="w">
</span><span class="c1">## 1 0.2972396   0.4165083 1.348223 1.16113 0.04220921</span><span class="w">

</span><span class="c1"># Derive validation lower prediction limits</span><span class="w">
</span><span class="n">lPL.mat</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">matrix</span><span class="p">(</span><span class="kc">NA</span><span class="p">,</span><span class="w"> </span><span class="n">nrow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nrow</span><span class="p">(</span><span class="n">fuz.me</span><span class="p">),</span><span class="w"> </span><span class="n">ncol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">10</span><span class="p">)</span><span class="w">
</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="n">ncol</span><span class="p">(</span><span class="n">lPL.mat</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="n">lPL.mat</span><span class="p">[,</span><span class="w"> </span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">DSM_data_val</span><span class="o">$</span><span class="n">RK_preds</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">lPI.mat</span><span class="p">[,</span><span class="w"> </span><span class="n">i</span><span class="p">]}</span><span class="w">

</span><span class="c1"># Derive validation upper prediction limits</span><span class="w">
</span><span class="n">uPL.mat</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">matrix</span><span class="p">(</span><span class="kc">NA</span><span class="p">,</span><span class="w"> </span><span class="n">nrow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nrow</span><span class="p">(</span><span class="n">fuz.me</span><span class="p">),</span><span class="w"> </span><span class="n">ncol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">10</span><span class="p">)</span><span class="w">
</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="n">ncol</span><span class="p">(</span><span class="n">uPL.mat</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="n">uPL.mat</span><span class="p">[,</span><span class="w"> </span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">DSM_data_val</span><span class="o">$</span><span class="n">RK_preds</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">uPI.mat</span><span class="p">[,</span><span class="w"> </span><span class="n">i</span><span class="p">]}</span><span class="w">
</span></code></pre></div></div>

<p>Now as in the previous uncertainty approaches we estimate the PICP for each level of confidence. We can also estimate the average prediction interval length too. We will do this for the 90% confidence level.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## PICP</span><span class="w">
</span><span class="n">bMat</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">matrix</span><span class="p">(</span><span class="kc">NA</span><span class="p">,</span><span class="w"> </span><span class="n">nrow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nrow</span><span class="p">(</span><span class="n">fuz.me</span><span class="p">),</span><span class="w"> </span><span class="n">ncol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">10</span><span class="p">)</span><span class="w">
</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="m">10</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="n">bMat</span><span class="p">[,</span><span class="w"> </span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">DSM_data_val</span><span class="o">$</span><span class="n">pH60_100cm</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">uPL.mat</span><span class="p">[,</span><span class="w"> </span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">DSM_data_val</span><span class="o">$</span><span class="n">pH60_100cm</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">lPL.mat</span><span class="p">[,</span><span class="w"> </span><span class="n">i</span><span class="p">])}</span><span class="w">

</span><span class="c1"># make plot</span><span class="w">
</span><span class="n">par</span><span class="p">(</span><span class="n">mfrow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">))</span><span class="w">
</span><span class="n">cs</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">99</span><span class="p">,</span><span class="w"> </span><span class="m">97.5</span><span class="p">,</span><span class="w"> </span><span class="m">95</span><span class="p">,</span><span class="w"> </span><span class="m">90</span><span class="p">,</span><span class="w"> </span><span class="m">80</span><span class="p">,</span><span class="w"> </span><span class="m">60</span><span class="p">,</span><span class="w"> </span><span class="m">40</span><span class="p">,</span><span class="w"> </span><span class="m">20</span><span class="p">,</span><span class="w"> </span><span class="m">10</span><span class="p">,</span><span class="w"> </span><span class="m">5</span><span class="p">)</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span><span class="w"> </span><span class="p">((</span><span class="n">colSums</span><span class="p">(</span><span class="n">bMat</span><span class="p">)</span><span class="o">/</span><span class="n">nrow</span><span class="p">(</span><span class="n">bMat</span><span class="p">))</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">100</span><span class="p">),</span><span class="w"> </span><span class="n">ylab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"PICP"</span><span class="p">,</span><span class="w"> </span><span class="n">xlab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"confidence level"</span><span class="p">)</span><span class="w">
</span><span class="c1"># draw 1:1 line</span><span class="w">
</span><span class="n">abline</span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"red"</span><span class="p">)</span><span class="w">

</span><span class="c1"># prediction interval width (averaged)</span><span class="w">
</span><span class="n">as.matrix</span><span class="p">(</span><span class="n">mean</span><span class="p">(</span><span class="n">uPL.mat</span><span class="p">[,</span><span class="w"> </span><span class="m">4</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">lPL.mat</span><span class="p">[,</span><span class="w"> </span><span class="m">4</span><span class="p">]))</span><span class="w">

</span><span class="c1">##          [,1]</span><span class="w">
</span><span class="c1">## [1,] 3.947908</span><span class="w">
</span></code></pre></div></div>

<figure>
<img src="/images/dsm_book/PICP_fuzzy.png" alt="rconsole" />
<figcaption>
lot of PICP and confidence level based on out-of-bag evaluation of
uncertainty estimation approach based on local errors and fuzzy
clustering.
</figcaption>
</figure>

<p><a href="#top">Back to top</a></p>

<h3 id="mapping-predictions-and-model-uncertainties-">Mapping predictions and model uncertainties <a id="s-7"></a></h3>

<p>With the spatial model defined together with the fuzzy clustering with the associated parameters and model errors, we can create the associated maps. First, the random forest regression kriging map.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## MAPPING random forest model extension</span><span class="w">
</span><span class="n">map.Rf</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">terra</span><span class="o">::</span><span class="n">predict</span><span class="p">(</span><span class="n">object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hv.sub.rasters</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hv.RF.Exp</span><span class="p">,</span><span class="w"> </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w">

</span><span class="c1"># kriged residuals</span><span class="w">
</span><span class="n">map.KR</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">terra</span><span class="o">::</span><span class="n">interpolate</span><span class="p">(</span><span class="n">object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hv.sub.rasters</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gR</span><span class="p">,</span><span class="w"> </span><span class="n">xyOnly</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w">

</span><span class="c1"># combine</span><span class="w">
</span><span class="n">map.final</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">map.Rf</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">map.KR</span><span class="p">[[</span><span class="m">1</span><span class="p">]]</span><span class="w">
</span></code></pre></div></div>

<p>Now we need to map the prediction intervals. Essentially for every pixel on the map we first need to estimate the membership value to each cluster. This membership is based on a distance of the covariate space and the centroids of each cluster. To do this we use the fuzzy allocation function (<code class="highlighter-rouge">fuzExall</code>) that was used earlier. This time we use the fuzzy parameters from the <code class="highlighter-rouge">tester</code> object. We need to firstly create a <code class="highlighter-rouge">data.frame</code> from the stack of covariates.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Prediction Intervals </span><span class="w">
</span><span class="c1"># get rasters into a data frame to advance calculation of memberships</span><span class="w">

</span><span class="n">hunterCovs.df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="n">cellNos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">seq</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="n">ncell</span><span class="p">(</span><span class="n">hv.sub.rasters</span><span class="p">)))</span><span class="w">
</span><span class="n">vals</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">as.data.frame</span><span class="p">(</span><span class="n">terra</span><span class="o">::</span><span class="n">values</span><span class="p">(</span><span class="n">hv.sub.rasters</span><span class="p">))</span><span class="w">
</span><span class="n">hunterCovs.df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">cbind</span><span class="p">(</span><span class="n">hunterCovs.df</span><span class="p">,</span><span class="w"> </span><span class="n">vals</span><span class="p">)</span><span class="w">
</span><span class="n">hunterCovs.df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">hunterCovs.df</span><span class="p">[</span><span class="n">complete.cases</span><span class="p">(</span><span class="n">hunterCovs.df</span><span class="p">),</span><span class="w"> </span><span class="p">]</span><span class="w">
</span><span class="n">cellNos</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">hunterCovs.df</span><span class="o">$</span><span class="n">cellNos</span><span class="p">)</span><span class="w">
</span><span class="n">gXY</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="n">terra</span><span class="o">::</span><span class="n">xyFromCell</span><span class="p">(</span><span class="n">hv.sub.rasters</span><span class="p">,</span><span class="w"> </span><span class="n">cellNos</span><span class="p">))</span><span class="w">
</span><span class="n">hunterCovs.df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">cbind</span><span class="p">(</span><span class="n">gXY</span><span class="p">,</span><span class="w"> </span><span class="n">hunterCovs.df</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>Now we prepare all the other inputs for the <code class="highlighter-rouge">fuzExall</code> function, and then run it. This may take a little time.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fuz.me_ALL</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">fuzExall</span><span class="p">(</span><span class="w">
</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hunterCovs.df</span><span class="p">[,</span><span class="w"> </span><span class="m">4</span><span class="o">:</span><span class="n">ncol</span><span class="p">(</span><span class="n">hunterCovs.df</span><span class="p">)],</span><span class="w"> 
</span><span class="n">centroid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tester</span><span class="o">$</span><span class="n">centroid</span><span class="p">,</span><span class="w">
</span><span class="n">phi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1.2</span><span class="p">,</span><span class="w"> 
</span><span class="n">distype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3</span><span class="p">,</span><span class="w"> 
</span><span class="n">W</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tester</span><span class="o">$</span><span class="n">distNormMat</span><span class="p">,</span><span class="w"> 
</span><span class="n">alfa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tester</span><span class="o">$</span><span class="n">alfa</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>With the memberships estimated, lets visualize them by creating the associated membership maps</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># attribute class allocation to maximum membership</span><span class="w">
</span><span class="n">membs.table</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">as.data.frame</span><span class="p">(</span><span class="n">fuz.me_ALL</span><span class="o">$</span><span class="n">membership</span><span class="p">)</span><span class="w">
</span><span class="n">membs.table</span><span class="o">$</span><span class="n">class</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="kc">NA</span><span class="w">
</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="n">nrow</span><span class="p">(</span><span class="n">membs.table</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="n">mbs2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">membs.table</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="m">5</span><span class="p">]</span><span class="w">
  </span><span class="c1"># which is the maximum probability on this row</span><span class="w">
  </span><span class="n">membs.table</span><span class="o">$</span><span class="n">class</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">which</span><span class="p">(</span><span class="n">mbs2</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nf">max</span><span class="p">(</span><span class="n">mbs2</span><span class="p">))[</span><span class="m">1</span><span class="p">]}</span><span class="w">

</span><span class="c1"># combine coordinates to memberships</span><span class="w">
</span><span class="n">hvCovs</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">cbind</span><span class="p">(</span><span class="n">hunterCovs.df</span><span class="p">[,</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="m">2</span><span class="p">],</span><span class="w"> </span><span class="n">membs.table</span><span class="p">)</span><span class="w">

</span><span class="c1"># Create rasters of memberships and class</span><span class="w">
</span><span class="n">map.class1mem</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">terra</span><span class="o">::</span><span class="n">rast</span><span class="p">(</span><span class="n">hvCovs</span><span class="p">[,</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">3</span><span class="p">)],</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"xyz"</span><span class="p">)</span><span class="w">
</span><span class="nf">names</span><span class="p">(</span><span class="n">map.class1mem</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s2">"class_1"</span><span class="w">
</span><span class="n">map.class2mem</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">terra</span><span class="o">::</span><span class="n">rast</span><span class="p">(</span><span class="n">hvCovs</span><span class="p">[,</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">4</span><span class="p">)],</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"xyz"</span><span class="p">)</span><span class="w">
</span><span class="nf">names</span><span class="p">(</span><span class="n">map.class2mem</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s2">"class_2"</span><span class="w">
</span><span class="n">map.class3mem</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">terra</span><span class="o">::</span><span class="n">rast</span><span class="p">(</span><span class="n">hvCovs</span><span class="p">[,</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">5</span><span class="p">)],</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"xyz"</span><span class="p">)</span><span class="w">
</span><span class="nf">names</span><span class="p">(</span><span class="n">map.class3mem</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s2">"class_3"</span><span class="w">
</span><span class="n">map.class4mem</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">terra</span><span class="o">::</span><span class="n">rast</span><span class="p">(</span><span class="n">hvCovs</span><span class="p">[,</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">6</span><span class="p">)],</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"xyz"</span><span class="p">)</span><span class="w">
</span><span class="nf">names</span><span class="p">(</span><span class="n">map.class4mem</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s2">"class_4"</span><span class="w">
</span><span class="n">map.classExtramem</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">terra</span><span class="o">::</span><span class="n">rast</span><span class="p">(</span><span class="n">hvCovs</span><span class="p">[,</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">7</span><span class="p">)],</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"xyz"</span><span class="p">)</span><span class="w">
</span><span class="nf">names</span><span class="p">(</span><span class="n">map.classExtramem</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s2">"class_ext"</span><span class="w">
</span><span class="n">map.class</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">terra</span><span class="o">::</span><span class="n">rast</span><span class="p">(</span><span class="n">hvCovs</span><span class="p">[,</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">8</span><span class="p">)],</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"xyz"</span><span class="p">)</span><span class="w">
</span><span class="nf">names</span><span class="p">(</span><span class="n">map.class</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s2">"class"</span><span class="w">

</span><span class="c1">## PLOTTING</span><span class="w">
</span><span class="n">par</span><span class="p">(</span><span class="n">mfrow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">3</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">))</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">map.class1mem</span><span class="p">,</span><span class="w"> </span><span class="n">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"class 1"</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">terrain.colors</span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">seq</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.2</span><span class="p">))</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">),</span><span class="w"> </span><span class="n">axes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">,</span><span class="w"> </span><span class="n">breaks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">seq</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.2</span><span class="p">))</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">map.class2mem</span><span class="p">,</span><span class="w"> </span><span class="n">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"class 2"</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">terrain.colors</span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">seq</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.2</span><span class="p">))</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">),</span><span class="w"> </span><span class="n">axes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">,</span><span class="w"> </span><span class="n">breaks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">seq</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.2</span><span class="p">))</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">map.class3mem</span><span class="p">,</span><span class="w"> </span><span class="n">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"class 3"</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">terrain.colors</span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">seq</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.2</span><span class="p">))</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">),</span><span class="w"> </span><span class="n">axes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">,</span><span class="w"> </span><span class="n">breaks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">seq</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.2</span><span class="p">))</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">map.class4mem</span><span class="p">,</span><span class="w"> </span><span class="n">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"class 4"</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">terrain.colors</span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">seq</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.2</span><span class="p">))</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">),</span><span class="w"> </span><span class="n">axes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">,</span><span class="w"> </span><span class="n">breaks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">seq</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.2</span><span class="p">))</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">map.classExtramem</span><span class="p">,</span><span class="w"> </span><span class="n">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Extragrade"</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">terrain.colors</span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">seq</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.2</span><span class="p">))</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">),</span><span class="w"> </span><span class="n">axes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">,</span><span class="w"> </span><span class="n">breaks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">seq</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.2</span><span class="p">))</span><span class="w">
</span><span class="n">levels</span><span class="p">(</span><span class="n">map.class</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="m">5</span><span class="p">,</span><span class="w"> </span><span class="n">desc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"Class 1"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Class 2"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Class 3"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Class 4"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Extragrade"</span><span class="p">))</span><span class="w">
</span><span class="n">area_colors</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"#FFFF00"</span><span class="p">,</span><span class="w"> </span><span class="s2">"#1D0BE0"</span><span class="p">,</span><span class="w"> </span><span class="s2">"#1CEB15"</span><span class="p">,</span><span class="w"> </span><span class="s2">"#808080"</span><span class="p">,</span><span class="w"> </span><span class="s2">"#C91601"</span><span class="p">)</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">map.class</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">area_colors</span><span class="p">,</span><span class="w"> </span><span class="n">plg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="n">loc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"bottomleft"</span><span class="p">,</span><span class="w"> </span><span class="n">cex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.6</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<figure>
<img src="/images/dsm_book/P7_mapping_fuzzy_memberships.png" alt="rconsole" />
<figcaption>
Fuzzy cluster memberships across study area.
</figcaption>
</figure>

<p>The last mapping task is to evaluate the 90% prediction intervals. Again we use the fuzzy committee approach given the cluster memberships and the cluster model error limits.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Mapping of upper and lower predicition limits Lower limits for each class</span><span class="w">
</span><span class="n">quanMat1</span><span class="p">[</span><span class="s2">"90"</span><span class="p">,</span><span class="w"> </span><span class="p">]</span><span class="w">

</span><span class="c1">##         1         2         3         4         5 </span><span class="w">
</span><span class="c1">## -1.609167 -1.949015 -1.805720 -1.452031 -2.495811</span><span class="w">

</span><span class="c1"># upper limits for each class</span><span class="w">
</span><span class="n">quanMat2</span><span class="p">[</span><span class="s2">"90"</span><span class="p">,</span><span class="w"> </span><span class="p">]</span><span class="w">

</span><span class="c1">##        1        2        3        4        5 </span><span class="w">
</span><span class="c1">## 2.060832 2.288711 2.340094 1.775154 3.330916</span><span class="w">
</span></code></pre></div></div>

<p>Now we perform the weighted averaging prediction.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># stack the rasters</span><span class="w">
</span><span class="n">s</span><span class="m">2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">map.class1mem</span><span class="p">,</span><span class="w"> </span><span class="n">map.class2mem</span><span class="p">,</span><span class="w"> </span><span class="n">map.class3mem</span><span class="p">,</span><span class="w"> </span><span class="n">map.class4mem</span><span class="p">,</span><span class="w"> </span><span class="n">map.classExtramem</span><span class="p">)</span><span class="w">

</span><span class="c1"># lower limit</span><span class="w">
</span><span class="n">f</span><span class="m">1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">((</span><span class="n">x</span><span class="p">[</span><span class="m">1</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">quanMat1</span><span class="p">[</span><span class="s2">"90"</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">])</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="m">2</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">quanMat1</span><span class="p">[</span><span class="s2">"90"</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">])</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="m">3</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">quanMat1</span><span class="p">[</span><span class="s2">"90"</span><span class="p">,</span><span class="w"> </span><span class="m">3</span><span class="p">])</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="m">4</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">quanMat1</span><span class="p">[</span><span class="s2">"90"</span><span class="p">,</span><span class="w"> </span><span class="m">4</span><span class="p">])</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="m">5</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">quanMat1</span><span class="p">[</span><span class="s2">"90"</span><span class="p">,</span><span class="w"> </span><span class="m">5</span><span class="p">]))</span><span class="w"> </span><span class="n">mapRK.lower</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">terra</span><span class="o">::</span><span class="n">app</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">fun</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f</span><span class="m">1</span><span class="p">)</span><span class="w">

</span><span class="c1"># upper limit</span><span class="w">
</span><span class="n">f</span><span class="m">2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">((</span><span class="n">x</span><span class="p">[</span><span class="m">1</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">quanMat2</span><span class="p">[</span><span class="s2">"90"</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">])</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="m">2</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">quanMat2</span><span class="p">[</span><span class="s2">"90"</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">])</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="m">3</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">quanMat2</span><span class="p">[</span><span class="s2">"90"</span><span class="p">,</span><span class="w"> </span><span class="m">3</span><span class="p">])</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="m">4</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">quanMat2</span><span class="p">[</span><span class="s2">"90"</span><span class="p">,</span><span class="w"> </span><span class="m">4</span><span class="p">])</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="m">5</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">quanMat2</span><span class="p">[</span><span class="s2">"90"</span><span class="p">,</span><span class="w"> </span><span class="m">5</span><span class="p">]))</span><span class="w"> </span><span class="n">mapRK.upper</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">terra</span><span class="o">::</span><span class="n">app</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">fun</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f</span><span class="m">2</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>And finally we can derive the upper and lower prediction limits.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## Final maps Lower prediction limit</span><span class="w">
</span><span class="n">map.final.lower</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">map.final</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">mapRK.lower</span><span class="w">

</span><span class="c1"># Upper prediction limit</span><span class="w">
</span><span class="n">map.final.upper</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">map.final</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">mapRK.upper</span><span class="w">

</span><span class="c1"># Prediction interval range</span><span class="w">
</span><span class="n">map.final.pir</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">map.final.upper</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">map.final.lower</span><span class="w">
</span></code></pre></div></div>

<p>And now we can display the necessary maps:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># color ramp</span><span class="w">
</span><span class="n">phCramp</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"#d53e4f"</span><span class="p">,</span><span class="w"> </span><span class="s2">"#f46d43"</span><span class="p">,</span><span class="w"> </span><span class="s2">"#fdae61"</span><span class="p">,</span><span class="w"> </span><span class="s2">"#fee08b"</span><span class="p">,</span><span class="w"> </span><span class="s2">"#ffffbf"</span><span class="p">,</span><span class="w"> </span><span class="s2">"#e6f598"</span><span class="p">,</span><span class="w"> </span><span class="s2">"#abdda4"</span><span class="p">,</span><span class="w"> </span><span class="s2">"#66c2a5"</span><span class="p">,</span><span class="w"> </span><span class="s2">"#3288bd"</span><span class="p">,</span><span class="w"> </span><span class="s2">"#5e4fa2"</span><span class="p">,</span><span class="w"> </span><span class="s2">"#542788"</span><span class="p">,</span><span class="w"> </span><span class="s2">"#2d004b"</span><span class="p">)</span><span class="w">

</span><span class="n">brk</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">2</span><span class="o">:</span><span class="m">14</span><span class="p">)</span><span class="w">
</span><span class="n">par</span><span class="p">(</span><span class="n">mfrow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">))</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">mapRF.lowerPI</span><span class="p">,</span><span class="w"> </span><span class="n">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"90% Lower prediction limit"</span><span class="p">,</span><span class="w"> </span><span class="n">breaks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">brk</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">phCramp</span><span class="p">)</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">mapRF.fin</span><span class="p">,</span><span class="w"> </span><span class="n">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Prediction"</span><span class="p">,</span><span class="w"> </span><span class="n">breaks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">brk</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">phCramp</span><span class="p">)</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">mapRF.upperPI</span><span class="p">,</span><span class="w"> </span><span class="n">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"90% Upper prediction limit"</span><span class="p">,</span><span class="w"> </span><span class="n">breaks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">brk</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">phCramp</span><span class="p">)</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">mapRF.PIrange</span><span class="p">,</span><span class="w"> </span><span class="n">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Prediction limit range"</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">terrain.colors</span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">seq</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">6.5</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">))</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">),</span><span class="w"> </span><span class="n">axes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">,</span><span class="w"> </span><span class="n">breaks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">seq</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">6.5</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<figure>
<img src="/images/dsm_book/P7_mapping_fuzzy.png" alt="rconsole" />
<figcaption>
Soil pH predictions and prediction limits derived using a Random Forest
regression kriging prediction model together with uncertainty estimation
based on local errors and fuzzy clustering.
</figcaption>
</figure>

<p><a href="#top">Back to top</a></p>

<h3 id="references-">References <a id="s-1"></a></h3>

<p>Bragato, G. 2004. “Fuzzy Continuous Classification and SpatialInterpolation in Conventional Soil Survey for Soil Mapping of the Lower Piave Plain.” <em>Geoderma</em> 118: 1–16.</p>

<p>Burrough, P. A, P. F. M van Gaans, and R Hootsmans. 1997. “Continuous Classifcation in Soil Survey: Spatial Correlation, Confusion and Boundaries.” <em>Geoderma</em> 77: 115–35.</p>

<p>Lagacherie, P., D. R. Cazemier, P. F. M. vanGaans, and P. A. Burrough. 1997. “Fuzzy k-Means Clustering of Fields in an Elementary Catchment and Extrapolation to a Larger Area.” <em>Geoderma</em> 77: 197–216.</p>

<p>Malone, B P, A B McBratney, and B Minasny. 2011. “Empirical Estimates of Uncertainty for Mapping Continuous Depth Functions of Soil Attributes.” <em>Geoderma</em> 160: 614–26.</p>

<p>McBratney, A. B., and J. J. de Gruijter. 1992. “Continuum Approach to Soil Classification by Modified Fuzzy k-Means with Extragrades.” <em>Journal of Soil Science</em> 43: 159–75.</p>

<p>Minasny, A. B., B McBratney. 2002. <em>FuzME Version 3.0</em>. Australian Centre for Precision Agriculture, The University of Sydney, Australia.</p>

<p>Odeh, I. O. A., A. B. McBratney, and D. J. Chittleborough. 1992. “Soil Pattern Recognition with Fuzzy-c-Means: Application to Classification and Soil-Landform Interrelationships.” <em>Soil Science Society of America Journal</em> 56: 506–16.</p>

<p>Shrestha, D. L, and D. P Solomatine. 2006. “Machine Learning Approaches for Estimation of Prediction Interval for the Model Output.” <em>Neural Networks</em> 19: 225–35.</p>

<p>Tranter, G., B. Minasny, and A. B. McBratney. 2010. “Estimating Pedotransfer Function Prediction Limits Using Fuzzy k-Means with Extragrades.” <em>Soil Science Society of America Journal</em> 74: 1967–75.</p>

<p><a href="#top">Back to top</a></p>

      <footer class="entry-meta">
        <span>Updated on <span class="entry-date date published updated"><time datetime="2023-09-21">September 21, 2023</time></span></span>
        <span class="author vcard"><span class="fn">Smart Digital Agriculture</span></span>
        <div class="social-share">
  <ul class="socialcount socialcount-small inline-list">
    <li class="facebook"><a href="https://www.facebook.com/sharer/sharer.php?u=/DSM_book/pages/uncerts/fuzzy/" title="Share on Facebook"><span class="count"><i class="fa fa-facebook-square"></i> Like</span></a></li>
    <li class="twitter"><a href="https://twitter.com/intent/tweet?text=/DSM_book/pages/uncerts/fuzzy/" title="Share on Twitter"><span class="count"><i class="fa fa-twitter-square"></i> Tweet</span></a></li>
    <li class="googleplus"><a href="https://plus.google.com/share?url=/DSM_book/pages/uncerts/fuzzy/" title="Share on Google Plus"><span class="count"><i class="fa fa-google-plus-square"></i> +1</span></a></li>
  </ul>
</div><!-- /.social-share -->
      </footer>
    </div><!-- /.entry-content -->
    
  </article>
</div><!-- /#main -->

<div class="footer-wrapper">
    <!--<span>&copy; 2025 Smart Digital Agriculture. Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> using the <a href="http://mademistakes.com/hpstr/" rel="notfollow">HPSTR Theme</a>.</span>-->

<footer role="contentinfo">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    <li>
                        <a href="/feed.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    <li>
                        <a href="mailto:malone.brendan1001@gmail.com">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="https://github.com/brendo1001">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="https://twitter.com/soilmalone">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    
                </ul>
                <p class="copyright text-muted">Copyright &copy; Smart Digital Agriculture 2025, All Rights Reserved.</p>
            </div>
        </div>
    </div>
</footer>

</div><!-- /.footer-wrapper -->

<!-- JQuery JavaScript -->
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>

<!-- Bootstrap Core JavaScript -->
<script src="/assets/js/vendor/bootstrap.min.js"></script>

<!-- Clean Blog JavaScript -->
<script src="/assets/js/clean-blog.min.js"></script>

<script src="/assets/js/scripts.min.js"></script>


<!-- Asynchronous Google Analytics snippet -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-87285093-1', 'auto');
  ga('require', 'linkid', 'linkid.js');
  ga('send', 'pageview');
</script>


<!-- Math equation support by MathJax -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        TeX: {
            equationNumbers: { autoNumber: "all" },
            inlineMath: [['$','$'],['\\(','\\)']],
        },
        "HTML-CSS": {
            availableFonts: ["TeX"],
            preferredFont: "TeX",
        },
    });
</script>
<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML"></script>




</body>
</html>
