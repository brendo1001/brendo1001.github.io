<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>Spatial Prediction &#8211; Smart Digital Agriculture</title>
<meta name="description" content="">


<!-- Twitter Cards -->
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="/images/">
<meta name="twitter:title" content="Spatial Prediction">
<meta name="twitter:description" content="">
<meta name="twitter:creator" content="@soilmalone">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="Spatial Prediction">
<meta property="og:description" content="">
<meta property="og:url" content="/DSM_book/pages/dsm_cont/prediction/">
<meta property="og:site_name" content="Smart Digital Agriculture">

<meta name="google-site-verification" content="googledd99b1430269a639.html">



<link rel="canonical" href="/DSM_book/pages/dsm_cont/prediction/">
<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Smart Digital Agriculture Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<!-- Bootstrap Core CSS -->
<link rel="stylesheet" href="/assets/css/bootstrap.min.css">
<!-- Clean Blog CSS -->
<link rel="stylesheet" href="/assets/css/clean-blog.css">
<!-- HPSTR main CSS -->
<link rel="stylesheet" href="/assets/css/main.css">

<meta http-equiv="cleartype" content="on">

<!-- Load Modernizr -->
<script src="/assets/js/vendor/modernizr-2.6.2.custom.min.js"></script>

<!-- Custom Fonts -->
<link href="//fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic" rel="stylesheet" type="text/css">
<link href='//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
<link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Viga|Ubuntu:700' rel='stylesheet' type='text/css'>
<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/images/apple-touch-icon-144x144-precomposed.png">



<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->

</head>

<body id="page" >

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->
<!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Smart Digital Agriculture</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                
                    
                    <li><a href="/" >Home</a></li>
                
                    
                    <li><a href="/publications/" >Publications</a></li>
                
                    
                    <li><a href="/software/" >Software</a></li>
                
                    
                    <li><a href="/blog/" >Journal Digests</a></li>
                
                    
                    <li><a href="/UseCases/" >Blog</a></li>
                
                    
                    <li><a href="/DSM_book/" >Using R for Digital Soil Mapping</a></li>
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>

<!-- Page Header -->
<header class="intro-header" style="background-image: url('/images/pedometric2017.jpg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="site-heading">
                    <h1>Spatial Prediction</h1>
                    
                        <hr class="small">
                        <span class="subheading"></span>
                    
                </div>
            </div>
        </div>
    </div>
</header>

<!--

-->

<div id="main" role="main">
  <article class="hentry">
    <!--
    <header class="header-title">
      <div class="header-title-wrap">
        <h1 class="entry-title">Spatial Prediction</h1>
        
        <p class="entry-reading-time">
          <i class="fa fa-clock-o"></i>
          
          Reading time ~12 minutes
        </p>
        
      </div>
    </header>
    -->
    <div class="entry-content">
      <h2 id="applying-models-spatially">Applying models spatially</h2>

<p>Here we will provide a brief overview of how applying models to unseen
data. The general idea is that one has fitted a model to predict some
soil phenomena using a suite of environmental covariates. Now you need
to use that model to apply to a the same covariates, but now these
covariates have continuous coverage across the area. Essentially you
want to create a soil map. There are a couple of ways to go about this.
First things first we need to prepare some data and fit a simple model.</p>

<ul>
  <li><a href="#s-1">Data preparation</a></li>
  <li><a href="#s-2">Model fitting</a></li>
  <li><a href="#s-3">Apply model: Covariate data frame</a></li>
  <li><a href="#s-4">Apply model: raster <code class="highlighter-rouge">predict</code> function</a></li>
  <li><a href="#s-5">Apply model: Parallel processing</a></li>
</ul>

<h3 id="data-preparation-">Data preparation <a id="s-1"></a></h3>

<p>Recall from before in the data preparatory exercises that we were
working with the soil point data and environmental covariates for the
Hunter Valley area. These data are stored in the <code class="highlighter-rouge">HV_subsoilpH</code> and
<code class="highlighter-rouge">hunterCovariates_sub</code> objects from the <code class="highlighter-rouge">ithir</code> package.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">library</span><span class="p">(</span><span class="n">ithir</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">raster</span><span class="p">)</span><span class="w">

</span><span class="c1">## Loading required package: sp</span><span class="w">

</span><span class="n">library</span><span class="p">(</span><span class="n">rgdal</span><span class="p">)</span><span class="w">

</span><span class="c1">## rgdal: version: 1.4-8, (SVN revision 845)</span><span class="w">
</span><span class="c1">##  Geospatial Data Abstraction Library extensions to R successfully loaded</span><span class="w">
</span><span class="c1">##  Loaded GDAL runtime: GDAL 2.2.3, released 2017/11/20</span><span class="w">
</span><span class="c1">##  Path to GDAL shared files: /usr/share/gdal/2.2</span><span class="w">
</span><span class="c1">##  GDAL binary built with GEOS: TRUE </span><span class="w">
</span><span class="c1">##  Loaded PROJ.4 runtime: Rel. 4.9.3, 15 August 2016, [PJ_VERSION: 493]</span><span class="w">
</span><span class="c1">##  Path to PROJ.4 shared files: (autodetected)</span><span class="w">
</span><span class="c1">##  Linking to sp version: 1.3-2</span><span class="w">

</span><span class="n">library</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span><span class="w">

</span><span class="c1"># point data</span><span class="w">
</span><span class="n">data</span><span class="p">(</span><span class="n">HV_subsoilpH</span><span class="p">)</span><span class="w">

</span><span class="c1"># Start afresh round pH data to 2 decimal places</span><span class="w">
</span><span class="n">HV_subsoilpH</span><span class="o">$</span><span class="n">pH60_100cm</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">round</span><span class="p">(</span><span class="n">HV_subsoilpH</span><span class="o">$</span><span class="n">pH60_100cm</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">)</span><span class="w">

</span><span class="c1"># remove already intersected data</span><span class="w">
</span><span class="n">HV_subsoilpH</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">HV_subsoilpH</span><span class="p">[,</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="m">3</span><span class="p">]</span><span class="w">

</span><span class="c1"># add an id column</span><span class="w">
</span><span class="n">HV_subsoilpH</span><span class="o">$</span><span class="n">id</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">seq</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">nrow</span><span class="p">(</span><span class="n">HV_subsoilpH</span><span class="p">),</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w">

</span><span class="c1"># re-arrange order of columns</span><span class="w">
</span><span class="n">HV_subsoilpH</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">HV_subsoilpH</span><span class="p">[,</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">3</span><span class="p">)]</span><span class="w">

</span><span class="c1"># Change names of coordinate columns</span><span class="w">
</span><span class="nf">names</span><span class="p">(</span><span class="n">HV_subsoilpH</span><span class="p">)[</span><span class="m">2</span><span class="o">:</span><span class="m">3</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"x"</span><span class="p">,</span><span class="w"> </span><span class="s2">"y"</span><span class="p">)</span><span class="w">

</span><span class="c1"># grids (covariate raster)</span><span class="w">
</span><span class="n">data</span><span class="p">(</span><span class="n">hunterCovariates_sub</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>Perform the covariate intersection.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">coordinates</span><span class="p">(</span><span class="n">HV_subsoilpH</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="o">~</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="w">

</span><span class="c1"># extract</span><span class="w">
</span><span class="n">DSM_data</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">extract</span><span class="p">(</span><span class="n">hunterCovariates_sub</span><span class="p">,</span><span class="w"> </span><span class="n">HV_subsoilpH</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"simple"</span><span class="p">)</span><span class="w">
</span><span class="n">DSM_data</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">as.data.frame</span><span class="p">(</span><span class="n">DSM_data</span><span class="p">)</span><span class="w">
</span><span class="n">str</span><span class="p">(</span><span class="n">DSM_data</span><span class="p">)</span><span class="w">

</span><span class="c1">## 'data.frame':    506 obs. of  15 variables:</span><span class="w">
</span><span class="c1">##  $ id                      : num  1 2 3 4 5 6 7 8 9 10 ...</span><span class="w">
</span><span class="c1">##  $ x                       : num  340386 340345 340559 340483 340734 ...</span><span class="w">
</span><span class="c1">##  $ y                       : num  6368690 6368491 6369168 6368740 6368964 ...</span><span class="w">
</span><span class="c1">##  $ pH60_100cm              : num  4.47 5.42 6.26 8.03 8.86 7.28 4.95 5.61 5.39 3.44 ...</span><span class="w">
</span><span class="c1">##  $ Terrain_Ruggedness_Index: num  1.34 1.42 1.64 1.04 1.27 ...</span><span class="w">
</span><span class="c1">##  $ AACN                    : num  1.619 0.281 2.301 1.74 3.114 ...</span><span class="w">
</span><span class="c1">##  $ Landsat_Band1           : num  57 47 59 52 62 53 47 52 53 63 ...</span><span class="w">
</span><span class="c1">##  $ Elevation               : num  103.1 103.7 99.9 101.9 99.8 ...</span><span class="w">
</span><span class="c1">##  $ Hillshading             : num  1.849 1.428 0.934 1.517 1.652 ...</span><span class="w">
</span><span class="c1">##  $ Light_insolation        : num  1689 1701 1722 1688 1735 ...</span><span class="w">
</span><span class="c1">##  $ Mid_Slope_Positon       : num  0.876 0.914 0.844 0.848 0.833 ...</span><span class="w">
</span><span class="c1">##  $ MRVBF                   : num  3.85 3.31 3.66 3.92 3.89 ...</span><span class="w">
</span><span class="c1">##  $ NDVI                    : num  -0.143 -0.386 -0.197 -0.14 -0.15 ...</span><span class="w">
</span><span class="c1">##  $ TWI                     : num  17.5 18.2 18.8 18 17.8 ...</span><span class="w">
</span><span class="c1">##  $ Slope                   : num  1.79 1.42 1.01 1.49 1.83 ...</span><span class="w">
</span></code></pre></div></div>

<p><a href="#top">Back to top</a></p>

<h3 id="model-fitting-">Model fitting <a id="s-2"></a></h3>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">hv.MLR.Full</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">lm</span><span class="p">(</span><span class="n">pH60_100cm</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="o">+</span><span class="n">Terrain_Ruggedness_Index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">AACN</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Landsat_Band1</span><span class="w"> </span><span class="o">+</span><span class="w"> 
    </span><span class="n">Elevation</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Hillshading</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Light_insolation</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Mid_Slope_Positon</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">MRVBF</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">NDVI</span><span class="w"> </span><span class="o">+</span><span class="w"> 
    </span><span class="n">TWI</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Slope</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DSM_data</span><span class="p">)</span><span class="w">
</span><span class="n">summary</span><span class="p">(</span><span class="n">hv.MLR.Full</span><span class="p">)</span><span class="w">

</span><span class="c1">## </span><span class="w">
</span><span class="c1">## Call:</span><span class="w">
</span><span class="c1">## lm(formula = pH60_100cm ~ +Terrain_Ruggedness_Index + AACN + </span><span class="w">
</span><span class="c1">##     Landsat_Band1 + Elevation + Hillshading + Light_insolation + </span><span class="w">
</span><span class="c1">##     Mid_Slope_Positon + MRVBF + NDVI + TWI + Slope, data = DSM_data)</span><span class="w">
</span><span class="c1">## </span><span class="w">
</span><span class="c1">## Residuals:</span><span class="w">
</span><span class="c1">##     Min      1Q  Median      3Q     Max </span><span class="w">
</span><span class="c1">## -3.2380 -0.7843 -0.1225  0.7057  3.4641 </span><span class="w">
</span><span class="c1">## </span><span class="w">
</span><span class="c1">## Coefficients:</span><span class="w">
</span><span class="c1">##                           Estimate Std. Error t value Pr(&gt;|t|)    </span><span class="w">
</span><span class="c1">## (Intercept)               5.372452   2.147673   2.502 0.012689 *  </span><span class="w">
</span><span class="c1">## Terrain_Ruggedness_Index  0.075084   0.054893   1.368 0.171991    </span><span class="w">
</span><span class="c1">## AACN                      0.034747   0.007241   4.798 2.12e-06 ***</span><span class="w">
</span><span class="c1">## Landsat_Band1            -0.037712   0.009355  -4.031 6.42e-05 ***</span><span class="w">
</span><span class="c1">## Elevation                -0.013535   0.005550  -2.439 0.015079 *  </span><span class="w">
</span><span class="c1">## Hillshading               0.152819   0.053655   2.848 0.004580 ** </span><span class="w">
</span><span class="c1">## Light_insolation          0.001329   0.001178   1.127 0.260081    </span><span class="w">
</span><span class="c1">## Mid_Slope_Positon         0.928823   0.268625   3.458 0.000592 ***</span><span class="w">
</span><span class="c1">## MRVBF                     0.324041   0.084942   3.815 0.000154 ***</span><span class="w">
</span><span class="c1">## NDVI                      4.982413   0.887322   5.615 3.28e-08 ***</span><span class="w">
</span><span class="c1">## TWI                       0.085150   0.045976   1.852 0.064615 .  </span><span class="w">
</span><span class="c1">## Slope                    -0.102262   0.062391  -1.639 0.101838    </span><span class="w">
</span><span class="c1">## ---</span><span class="w">
</span><span class="c1">## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span><span class="w">
</span><span class="c1">## </span><span class="w">
</span><span class="c1">## Residual standard error: 1.178 on 494 degrees of freedom</span><span class="w">
</span><span class="c1">## Multiple R-squared:  0.2501, Adjusted R-squared:  0.2334 </span><span class="w">
</span><span class="c1">## F-statistic: 14.97 on 11 and 494 DF,  p-value: &lt; 2.2e-16</span><span class="w">
</span></code></pre></div></div>

<p><a href="#top">Back to top</a></p>

<h3 id="applying-the-model-spatially-using-data-frames-">Applying the model spatially using data frames <a id="s-3"></a></h3>

<p>The traditional approach has been to collate a grid table where there
would be two columns for the coordinates followed by other columns for
each of the available covariates that were sourced. This was seen as an
efficient way to organize all the covariate data as it ensured that a
common grid was used which also meant that all the covariates are of the
same scale in terms of resolution and extent. We can simulate the
covariate table approach using the <code class="highlighter-rouge">hunterCovariates_sub</code> object as
below.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">data</span><span class="p">(</span><span class="n">hunterCovariates_sub</span><span class="p">)</span><span class="w">
</span><span class="n">tempD</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="n">cellNos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">seq</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="n">ncell</span><span class="p">(</span><span class="n">hunterCovariates_sub</span><span class="p">)))</span><span class="w">
</span><span class="n">vals</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">as.data.frame</span><span class="p">(</span><span class="n">getValues</span><span class="p">(</span><span class="n">hunterCovariates_sub</span><span class="p">))</span><span class="w">
</span><span class="n">tempD</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">cbind</span><span class="p">(</span><span class="n">tempD</span><span class="p">,</span><span class="w"> </span><span class="n">vals</span><span class="p">)</span><span class="w">
</span><span class="n">tempD</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">tempD</span><span class="p">[</span><span class="n">complete.cases</span><span class="p">(</span><span class="n">tempD</span><span class="p">),</span><span class="w"> </span><span class="p">]</span><span class="w">
</span><span class="n">cellNos</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">tempD</span><span class="o">$</span><span class="n">cellNos</span><span class="p">)</span><span class="w">
</span><span class="n">gXY</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="n">xyFromCell</span><span class="p">(</span><span class="n">hunterCovariates_sub</span><span class="p">,</span><span class="w"> </span><span class="n">cellNos</span><span class="p">,</span><span class="w"> </span><span class="n">spatial</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">))</span><span class="w">
</span><span class="n">tempD</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">cbind</span><span class="p">(</span><span class="n">gXY</span><span class="p">,</span><span class="w"> </span><span class="n">tempD</span><span class="p">)</span><span class="w">
</span><span class="n">str</span><span class="p">(</span><span class="n">tempD</span><span class="p">)</span><span class="w">

</span><span class="c1">## 'data.frame':    33252 obs. of  14 variables:</span><span class="w">
</span><span class="c1">##  $ x                       : num  340935 340960 340985 341010 341035 ...</span><span class="w">
</span><span class="c1">##  $ y                       : num  6370416 6370416 6370416 6370416 6370416 ...</span><span class="w">
</span><span class="c1">##  $ cellNos                 : int  101 102 103 104 105 106 107 108 109 110 ...</span><span class="w">
</span><span class="c1">##  $ Terrain_Ruggedness_Index: num  0.745 0.632 0.535 0.472 0.486 ...</span><span class="w">
</span><span class="c1">##  $ AACN                    : num  9.78 9.86 10.04 10.27 10.53 ...</span><span class="w">
</span><span class="c1">##  $ Landsat_Band1           : num  68 63 59 62 56 54 59 62 54 56 ...</span><span class="w">
</span><span class="c1">##  $ Elevation               : num  103 103 102 102 102 ...</span><span class="w">
</span><span class="c1">##  $ Hillshading             : num  0.94 0.572 0.491 0.515 0.568 ...</span><span class="w">
</span><span class="c1">##  $ Light_insolation        : num  1712 1706 1701 1699 1697 ...</span><span class="w">
</span><span class="c1">##  $ Mid_Slope_Positon       : num  0.389 0.387 0.386 0.386 0.386 ...</span><span class="w">
</span><span class="c1">##  $ MRVBF                   : num  0.376 0.765 1.092 1.54 1.625 ...</span><span class="w">
</span><span class="c1">##  $ NDVI                    : num  -0.178 -0.18 -0.164 -0.169 -0.172 ...</span><span class="w">
</span><span class="c1">##  $ TWI                     : num  16.9 17.2 17.2 17.2 17.2 ...</span><span class="w">
</span><span class="c1">##  $ Slope                   : num  0.968 0.588 0.503 0.527 0.581 ...</span><span class="w">
</span></code></pre></div></div>

<p>The result shown above is that the covariate table contains 33252 rows
and has 14 variables. It is always necessary to have the coordinate
columns, but some saving of memory could be earned if only the required
covariates are appended to the table. It will quickly become obvious
however that the covariate table approach could be limiting when mapping
extents get very large or the grid resolution of mapping becomes more
fine-grained, or both.</p>

<p>With the covariate table arranged it then becomes a matter of using the
MLR <code class="highlighter-rouge">predict</code> function.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">map.MLR</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">predict</span><span class="p">(</span><span class="n">hv.MLR.Full</span><span class="p">,</span><span class="w"> </span><span class="n">newdata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tempD</span><span class="p">)</span><span class="w">
</span><span class="n">map.MLR</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">cbind</span><span class="p">(</span><span class="n">data.frame</span><span class="p">(</span><span class="n">tempD</span><span class="p">[,</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"x"</span><span class="p">,</span><span class="w"> </span><span class="s2">"y"</span><span class="p">)]),</span><span class="w"> </span><span class="n">map.MLR</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>Now we can rasterise the predictions for mapping and grid export. In the
example below we set the CRS to WGS84 Zone 56 before exporting the
raster file out as a Geotiff file.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">map.MLR.r</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rasterFromXYZ</span><span class="p">(</span><span class="n">as.data.frame</span><span class="p">(</span><span class="n">map.MLR</span><span class="p">[,</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="m">3</span><span class="p">]))</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">map.MLR.r</span><span class="p">,</span><span class="w"> </span><span class="n">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"MLR predicted soil pH (60-100cm)"</span><span class="p">)</span><span class="w">
</span><span class="c1"># set the projection</span><span class="w">
</span><span class="n">crs</span><span class="p">(</span><span class="n">map.MLR.r</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s2">"+proj=utm +zone=56 + south + ellps=WGS84 +datum=WGS84 +units=m +no_defs"</span><span class="w">
</span><span class="n">writeRaster</span><span class="p">(</span><span class="n">map.MLR.r</span><span class="p">,</span><span class="w"> </span><span class="s2">"soilpH_60_100_MLR.tif"</span><span class="p">,</span><span class="w"> </span><span class="n">format</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"GTiff"</span><span class="p">,</span><span class="w"> </span><span class="n">datatype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"FLT4S"</span><span class="p">,</span><span class="w"> 
    </span><span class="n">overwrite</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w">
</span><span class="c1"># check working directory for presence of raster</span><span class="w">
</span></code></pre></div></div>

<figure>
    <img src="/images/dsm_book/MLRcvt_hv.png" alt="rconsole" />
    <figcaption> MLR predicted soil pH 60-100cm across the Hunter Valley.</figcaption>
</figure>

<p>Some of the parameters used within the <code class="highlighter-rouge">writeRaster</code> function that are
worth noting include: <code class="highlighter-rouge">format</code>, which is the raster format that we want
to write to. Here <code class="highlighter-rouge">GTiff</code> is being specified â€” use the <code class="highlighter-rouge">writeFormats</code>
function to look at what other raster formats can be used. the parameter
<code class="highlighter-rouge">datatype</code> is specified as <code class="highlighter-rouge">FLT4S</code> which indicates that a 4 byte, signed
floating point values are to be written to file. Look at the function
<code class="highlighter-rouge">dataType</code> to look at other alternatives, for example for categorical
data where we may be interested in logical or integer values.</p>

<h3 id="applying-the-model-spatially-using-raster-predict-">Applying the model spatially using <code class="highlighter-rouge">raster predict</code> <a id="s-4"></a></h3>

<p>Probably a more efficient way of applying the fitted model is to apply
it directly to the rasters themselves. This avoids the step of arranging
all covariates into table format. If multiple rasters are being used, it
is necessary to have them arranged as a <code class="highlighter-rouge">rasterStack</code> object. This is
useful as it also ensures all the rasters are of the same extent and
resolution. Here we can use the <code class="highlighter-rouge">raster</code> <code class="highlighter-rouge">predict</code> function such as
below using the <code class="highlighter-rouge">covStack</code> raster stack as input.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">map.MLR.r1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">predict</span><span class="p">(</span><span class="n">hunterCovariates_sub</span><span class="p">,</span><span class="w"> </span><span class="n">hv.MLR.Full</span><span class="p">,</span><span class="w"> </span><span class="s2">"soilpH_60_100_MLR.tif"</span><span class="p">,</span><span class="w"> 
    </span><span class="n">format</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"GTiff"</span><span class="p">,</span><span class="w"> </span><span class="n">datatype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"FLT4S"</span><span class="p">,</span><span class="w"> </span><span class="n">overwrite</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w">
</span><span class="c1"># check working directory for presence of raster</span><span class="w">
</span></code></pre></div></div>

<p><a href="#top">Back to top</a></p>

<h3 id="applying-the-model-spatially-using-parallel-processing-">Applying the model spatially using parallel processing <a id="s-5"></a></h3>

<p>An extension of using the raster <code class="highlighter-rouge">predict</code> function is to apply the
model again to the rasters, but to do it across multiple computer nodes.
This is akin to breaking a job up into smaller pieces then processing
the jobs in parallel rather than sequentially. The parallel component
here is that the smaller pieces are passed to more than 1 compute nodes.
Most desktop computers these days can have up to 8 compute nodes which
can result in some excellent gains in efficiency when applying models
across massive extents and or at fine resolutions. The <code class="highlighter-rouge">raster</code> package
has some built in dependencies with other <code class="highlighter-rouge">R</code> packages that facilitate
parallel processing options. For example the <code class="highlighter-rouge">raster</code> package ports with
the <code class="highlighter-rouge">parallel</code> package for setting up and controlling the compute node
processes. The script below is an example of using 4 compute nodes to
apply the <code class="highlighter-rouge">hv.MLR.Full</code> model to the <code class="highlighter-rouge">hunterCovariates_sub</code> raster
stack.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">library</span><span class="p">(</span><span class="n">parallel</span><span class="p">)</span><span class="w">
</span><span class="n">beginCluster</span><span class="p">(</span><span class="m">4</span><span class="p">)</span><span class="w">
</span><span class="n">cluserMLR.pred</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">clusterR</span><span class="p">(</span><span class="n">hunterCovariates_sub</span><span class="p">,</span><span class="w"> </span><span class="n">predict</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="n">hv.MLR.Full</span><span class="p">),</span><span class="w"> 
    </span><span class="n">filename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"soilpH_60_100_MLR_pred.tif"</span><span class="p">,</span><span class="w"> </span><span class="n">format</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"GTiff"</span><span class="p">,</span><span class="w"> </span><span class="n">progress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">,</span><span class="w"> 
    </span><span class="n">overwrite</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">T</span><span class="p">)</span><span class="w">
</span><span class="n">endCluster</span><span class="p">()</span><span class="w">
</span></code></pre></div></div>

<p>To set up the compute nodes, you use the <code class="highlighter-rouge">beginCluster</code> function and
inside it, specify how many compute nodes you want to use. If empty
brackets are used, the function will use 100% of the compute resources.
The <code class="highlighter-rouge">clusterR</code> function is the work horse function that then applies the
model in parallel to the rasters. The parameters and subsequent options
are similar to the raster <code class="highlighter-rouge">predict</code> function, although it would help to
look at the help files on this function for more detailed explanations.
It is always important after the prediction is completed to shutdown the
nodes using the <code class="highlighter-rouge">endCluster</code> function.</p>

<p>The relative ease in setting up the parallel processing for our mapping
needs has really opened up the potential for performing DSM using very
large data sets and rasters. Moreover, using the parallel processing
together with the file pointing ability (that was discussed earlier)
<code class="highlighter-rouge">raster</code> has made the possibility of big DSM a reality, and importantly-
practicable.</p>

<p><a href="#top">Back to top</a></p>

      <footer class="entry-meta">
        <span>Updated on <span class="entry-date date published updated"><time datetime="2020-07-26">July 26, 2020</time></span></span>
        <span class="author vcard"><span class="fn">Smart Digital Agriculture</span></span>
        <div class="social-share">
  <ul class="socialcount socialcount-small inline-list">
    <li class="facebook"><a href="https://www.facebook.com/sharer/sharer.php?u=/DSM_book/pages/dsm_cont/prediction/" title="Share on Facebook"><span class="count"><i class="fa fa-facebook-square"></i> Like</span></a></li>
    <li class="twitter"><a href="https://twitter.com/intent/tweet?text=/DSM_book/pages/dsm_cont/prediction/" title="Share on Twitter"><span class="count"><i class="fa fa-twitter-square"></i> Tweet</span></a></li>
    <li class="googleplus"><a href="https://plus.google.com/share?url=/DSM_book/pages/dsm_cont/prediction/" title="Share on Google Plus"><span class="count"><i class="fa fa-google-plus-square"></i> +1</span></a></li>
  </ul>
</div><!-- /.social-share -->
      </footer>
    </div><!-- /.entry-content -->
    
  </article>
</div><!-- /#main -->

<div class="footer-wrapper">
    <!--<span>&copy; 2023 Smart Digital Agriculture. Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> using the <a href="http://mademistakes.com/hpstr/" rel="notfollow">HPSTR Theme</a>.</span>-->

<footer role="contentinfo">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    <li>
                        <a href="/feed.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    <li>
                        <a href="mailto:malone.brendan1001@gmail.com">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="https://github.com/brendo1001">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="https://twitter.com/soilmalone">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    
                </ul>
                <p class="copyright text-muted">Copyright &copy; Smart Digital Agriculture 2023, All Rights Reserved.</p>
            </div>
        </div>
    </div>
</footer>

</div><!-- /.footer-wrapper -->

<!-- JQuery JavaScript -->
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>

<!-- Bootstrap Core JavaScript -->
<script src="/assets/js/vendor/bootstrap.min.js"></script>

<!-- Clean Blog JavaScript -->
<script src="/assets/js/clean-blog.min.js"></script>

<script src="/assets/js/scripts.min.js"></script>


<!-- Asynchronous Google Analytics snippet -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-87285093-1', 'auto');
  ga('require', 'linkid', 'linkid.js');
  ga('send', 'pageview');
</script>


<!-- Math equation support by MathJax -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        TeX: {
            equationNumbers: { autoNumber: "all" },
            inlineMath: [['$','$'],['\\(','\\)']],
        },
        "HTML-CSS": {
            availableFonts: ["TeX"],
            preferredFont: "TeX",
        },
    });
</script>
<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML"></script>




</body>
</html>
