<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>Multinomial logistic regression &#8211; Smart Digital Agriculture</title>
<meta name="description" content="Categorical Variables">


<!-- Twitter Cards -->
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="/images/">
<meta name="twitter:title" content="Multinomial logistic regression">
<meta name="twitter:description" content="Categorical Variables">
<meta name="twitter:creator" content="@soilmalone">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="Multinomial logistic regression">
<meta property="og:description" content="Categorical Variables">
<meta property="og:url" content="/DSM_book/pages/dsm_cat/mlr/">
<meta property="og:site_name" content="Smart Digital Agriculture">

<meta name="google-site-verification" content="googledd99b1430269a639.html">



<link rel="canonical" href="/DSM_book/pages/dsm_cat/mlr/">
<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Smart Digital Agriculture Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<!-- Bootstrap Core CSS -->
<link rel="stylesheet" href="/assets/css/bootstrap.min.css">
<!-- Clean Blog CSS -->
<link rel="stylesheet" href="/assets/css/clean-blog.css">
<!-- HPSTR main CSS -->
<link rel="stylesheet" href="/assets/css/main.css">

<meta http-equiv="cleartype" content="on">

<!-- Load Modernizr -->
<script src="/assets/js/vendor/modernizr-2.6.2.custom.min.js"></script>

<!-- Custom Fonts -->
<link href="//fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic" rel="stylesheet" type="text/css">
<link href='//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
<link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Viga|Ubuntu:700' rel='stylesheet' type='text/css'>
<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/images/apple-touch-icon-144x144-precomposed.png">



<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->

</head>

<body id="page" >

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->
<!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Smart Digital Agriculture</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                
                    
                    <li><a href="/" >Home</a></li>
                
                    
                    <li><a href="/publications/" >Publications</a></li>
                
                    
                    <li><a href="/software/" >Software</a></li>
                
                    
                    <li><a href="/blog/" >Journal Digests</a></li>
                
                    
                    <li><a href="/UseCases/" >Blog</a></li>
                
                    
                    <li><a href="/DSM_book/" >Using R for Digital Soil Mapping</a></li>
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>

<!-- Page Header -->
<header class="intro-header" style="background-image: url('/images/pedometric2017.jpg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="site-heading">
                    <h1>Multinomial logistic regression</h1>
                    
                        <hr class="small">
                        <span class="subheading">Categorical Variables</span>
                    
                </div>
            </div>
        </div>
    </div>
</header>

<!--

-->

<div id="main" role="main">
  <article class="hentry">
    <!--
    <header class="header-title">
      <div class="header-title-wrap">
        <h1 class="entry-title">Multinomial logistic regression</h1>
        
        <p class="entry-reading-time">
          <i class="fa fa-clock-o"></i>
          
          Reading time ~13 minutes
        </p>
        
      </div>
    </header>
    -->
    <div class="entry-content">
      <h4 id="code">CODE:</h4>
<p><a href="/DSM_book/rcode/P6_SSPF_cate_2017_MNLR.R">Get the code used for this section
here</a></p>

<h3 id="multinomial-logistic-regression">Multinomial logistic regression</h3>

<ul>
  <li><a href="#s-1">Introduction</a></li>
  <li><a href="#s-2">Data preparation</a></li>
  <li><a href="#s-3">Model fitting</a></li>
  <li><a href="#s-4">Model goodness of fit</a></li>
  <li><a href="#s-5">Applying the model spatially</a></li>
</ul>

<h3 id="introduction-">Introduction <a id="s-1"></a></h3>

<p>Multinomial logistic regression is used to model nominal outcome variables, in which the log odds of the outcomes are modeled as a linear combination of the predictor variables.</p>

<p>Because we are dealing with categorical variables, it is necessary that logistic regression take the natural logarithm of the odds (log-odds) to create a continuous criterion. The logit of success is then fit to the predictors using regression analysis.</p>

<p>The results of the logit, however are not intuitive, so the logit is converted back to the odds via the inverse of the natural logarithm, namely the exponential function. Therefore, although the observed variables in logistic regression are categorical, the predicted scores are modeled as a continuous variable (the logit). The logit is referred to as the link function in logistic regression.</p>

<p>Although the output in logistic regression will be binomial or
multinomial, the logit is an underlying continuous criterion upon which linear regression is conducted. This means that for logistic regression we are able to return the most likely or probable prediction (class) as well as the probabilities of occurrence for all the other classes considered. Some discussion of the theoretical underpinnings of multinomial logistic regression, and importantly its application in DSM
is given in Kempen et al. (2009).</p>

<p><a href="#top">Back to top</a></p>

<h3 id="data-preparation-">Data Preparation <a id="s-2"></a></h3>

<p>In <code class="highlighter-rouge">R</code> we can use the <code class="highlighter-rouge">multinom</code> function from the <code class="highlighter-rouge">nnet</code> package to perform logistic regression. The are other implementations of this model in <code class="highlighter-rouge">R</code>, so it is worth a look to compare and contrast them. Fitting <code class="highlighter-rouge">multinom</code> is just like fitting a linear model as seen below.</p>

<p>As described earlier, the data to be used for the following modelling exercises are Terron classes as sampled from the map presented in Malone et al. 2014.The sample data contains 1000 cases of which there are 12 different Terron classes. Before getting into the modeling, we first load in the data and then perform the covariate layer intersection using the suite of environmental variables sourced from the <code class="highlighter-rouge">ithir</code> package.</p>

<p>The small selection of covariates cover an area of approximately 220km<sup>2</sup> at a spatial resolution of 25m. All these variables are derived primarily from an available digital elevation model.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## load libraries</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">ithir</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">sf</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">terra</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">nnet</span><span class="p">)</span><span class="w">

</span><span class="c1"># point data of terron classifications</span><span class="w">
</span><span class="n">data</span><span class="p">(</span><span class="n">hvTerronDat</span><span class="p">)</span><span class="w">

</span><span class="c1"># environmental covariates grids (covariate rasters from ithir package)</span><span class="w">
</span><span class="n">hv.rasters</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">list.files</span><span class="p">(</span><span class="n">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">system.file</span><span class="p">(</span><span class="s2">"extdata/"</span><span class="p">,</span><span class="w"> </span><span class="n">package</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"ithir"</span><span class="p">),</span><span class="w"> </span><span class="n">pattern</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"hunterCovariates_A"</span><span class="p">,</span><span class="w"> </span><span class="n">full.names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">T</span><span class="p">)</span><span class="w">

</span><span class="c1"># read them into R as SpatRaster objects</span><span class="w">
</span><span class="n">hv.rasters</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">terra</span><span class="o">::</span><span class="n">rast</span><span class="p">(</span><span class="n">hv.rasters</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>Transform the <code class="highlighter-rouge">hvTerronDat</code> data to a <code class="highlighter-rouge">sf</code> object or simple feature collection which will permit spatial analysis to tak place.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">hvTerronDat</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sf</span><span class="o">::</span><span class="n">st_as_sf</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hvTerronDat</span><span class="p">,</span><span class="w"> </span><span class="n">coords</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"x"</span><span class="p">,</span><span class="w"> </span><span class="s2">"y"</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<p>As these data are of the same spatial projection as the raster data, there is no need to perform a coordinate transformation. So we can perform the intersection immediately.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## Covariate data extraction</span><span class="w">
</span><span class="n">DSM_data</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">terra</span><span class="o">::</span><span class="n">extract</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hv.rasters</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hvTerronDat</span><span class="p">,</span><span class="w"> </span><span class="n">bind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">T</span><span class="p">,</span><span class="w"> </span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"simple"</span><span class="p">)</span><span class="w">
</span><span class="n">DSM_data</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">as.data.frame</span><span class="p">(</span><span class="n">DSM_data</span><span class="p">)</span><span class="w">
</span><span class="n">str</span><span class="p">(</span><span class="n">DSM_data</span><span class="p">)</span><span class="w">

</span><span class="c1">## 'data.frame':    1000 obs. of  9 variables:</span><span class="w">
</span></code></pre></div></div>

<p>It is always good practice to check to see if any of the observational data returned any <code class="highlighter-rouge">NA</code> values for any one of the covariates. If there is <code class="highlighter-rouge">NA</code> values, it indicates that the observational data is outside the extent of the covariate layers. It is best to remove these observations from the data set.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## remove missing data</span><span class="w">
</span><span class="n">which</span><span class="p">(</span><span class="o">!</span><span class="n">complete.cases</span><span class="p">(</span><span class="n">DSM_data</span><span class="p">))</span><span class="w">

</span><span class="c1">## integer(0)</span><span class="w">

</span><span class="n">DSM_data</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">DSM_data</span><span class="p">[</span><span class="n">complete.cases</span><span class="p">(</span><span class="n">DSM_data</span><span class="p">),</span><span class="w"> </span><span class="p">]</span><span class="w">
</span></code></pre></div></div>

<p><a href="#top">Back to top</a></p>

<h3 id="model-fitting-">Model Fitting <a id="s-3"></a></h3>

<p>Now for model fitting. The target variable is <code class="highlighter-rouge">terron</code>. So lets just use all the available covariates in the model. We will also subset the data for an out-of-bag model evaluation using the random hold back sampling method.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Multinomial logistic regression model establish calibration and out-of-bag</span><span class="w">
</span><span class="c1"># data sets</span><span class="w">
</span><span class="n">set.seed</span><span class="p">(</span><span class="m">655</span><span class="p">)</span><span class="w">
</span><span class="n">training</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sample</span><span class="p">(</span><span class="n">nrow</span><span class="p">(</span><span class="n">DSM_data</span><span class="p">),</span><span class="w"> </span><span class="m">0.7</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">nrow</span><span class="p">(</span><span class="n">DSM_data</span><span class="p">))</span><span class="w">

</span><span class="c1"># Multinomial logistic regression model</span><span class="w">
</span><span class="n">hv.MNLR</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">nnet</span><span class="o">::</span><span class="n">multinom</span><span class="p">(</span><span class="n">terron</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">hunterCovariates_A_AACN</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">hunterCovariates_A_elevation</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">hunterCovariates_A_Hillshading</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">hunterCovariates_A_light_insolation</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">hunterCovariates_A_MRVBF</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">hunterCovariates_A_Slope</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">hunterCovariates_A_TRI</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">hunterCovariates_A_TWI</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DSM_data</span><span class="p">[</span><span class="n">training</span><span class="p">,</span><span class="w"> </span><span class="p">])</span><span class="w">
</span></code></pre></div></div>

<p>Using the <code class="highlighter-rouge">summary</code> function allows us to see the linear models for each Terron class, which are the result of the log-odds of each soil class modeled as a linear combination of the covariates. We can also see the probabilities of occurrence for each Terron class at each observation location by using the <code class="highlighter-rouge">fitted</code> function.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## Model summary</span><span class="w">
</span><span class="n">summary</span><span class="p">(</span><span class="n">hv.MNLR</span><span class="p">)</span><span class="w">

</span><span class="c1">## Call:</span><span class="w">
</span><span class="c1">## nnet::multinom(formula = terron ~ hunterCovariates_A_AACN + hunterCovariates_A_elevation + </span><span class="w">
</span><span class="c1">##     hunterCovariates_A_Hillshading + hunterCovariates_A_light_insolation + </span><span class="w">
</span><span class="c1">##     hunterCovariates_A_MRVBF + hunterCovariates_A_Slope + hunterCovariates_A_TRI + </span><span class="w">
</span><span class="c1">##     hunterCovariates_A_TWI, data = DSM_data[training, ])</span><span class="w">
</span><span class="c1">## </span><span class="w">
</span><span class="c1">## Coefficients:</span><span class="w">
</span><span class="c1">#</span><span class="w">
</span><span class="c1">## </span><span class="w">
</span><span class="c1">## Residual Deviance: 1565.641 </span><span class="w">
</span><span class="c1">## AIC: 1763.641</span><span class="w">

</span><span class="c1"># Estimate class probabilities</span><span class="w">
</span><span class="n">probs.hv.MNLR</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">fitted</span><span class="p">(</span><span class="n">hv.MNLR</span><span class="p">)</span><span class="w">

</span><span class="c1"># return top of data frame of probabilities</span><span class="w">
</span><span class="n">head</span><span class="p">(</span><span class="n">probs.hv.MNLR</span><span class="p">)</span><span class="w">

</span><span class="c1">##                1            2            3            4            5</span><span class="w">
</span><span class="c1">## 366 3.180013e-07 6.777814e-03 4.903625e-01 0.0001686759 0.0001705747</span><span class="w">
</span><span class="c1">## 79  1.494619e-06 8.747864e-07 3.335882e-03 0.0358131506 0.0226158580</span><span class="w">
</span><span class="c1">## 946 7.747219e-07 1.390212e-05 3.110918e-03 0.0063934663 0.0814475628</span><span class="w">
</span><span class="c1">## 148 8.990125e-09 6.399129e-10 2.020176e-07 0.0116442200 0.5644019303</span><span class="w">
</span><span class="c1">## 710 5.758595e-04 3.707932e-03 6.952536e-01 0.0103778544 0.0001168495</span><span class="w">
</span><span class="c1">## 729 1.232164e-11 8.209651e-10 4.582702e-08 0.0003529924 0.4953536210</span><span class="w">
</span><span class="c1">##    </span><span class="w">
</span></code></pre></div></div>

<p>Subsequently, we can also determine the most probable Terron class using the <code class="highlighter-rouge">predict</code> function.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## model prediction</span><span class="w">
</span><span class="n">pred.hv.MNLR</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">predict</span><span class="p">(</span><span class="n">hv.MNLR</span><span class="p">)</span><span class="w">
</span><span class="n">summary</span><span class="p">(</span><span class="n">pred.hv.MNLR</span><span class="p">)</span><span class="w">

</span><span class="c1">##   1   2   3   4   5   6   7   8   9  10  11  12 </span><span class="w">
</span><span class="c1">##  20   6  82  42 111  61 143 122  47  28  24  14</span><span class="w">
</span></code></pre></div></div>

<p><a href="#top">Back to top</a></p>

<h3 id="model-goodness-of-fit-evaluation-">Model goodness of fit evaluation <a id="s-4"></a></h3>

<p>Lets now perform an internal validation of the model to assess its general performance. Here we use the <code class="highlighter-rouge">goofcat</code> function that was <a href="/DSM_book/pages/dsm_cat/val/">introduced earlier</a>, but this time we import the two vectors into the function which correspond to the observations and predictions respectively.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## goodness of fit (calibration)</span><span class="w">
</span><span class="n">ithir</span><span class="o">::</span><span class="n">goofcat</span><span class="p">(</span><span class="n">observed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DSM_data</span><span class="o">$</span><span class="n">terron</span><span class="p">[</span><span class="n">training</span><span class="p">],</span><span class="w"> </span><span class="n">predicted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pred.hv.MNLR</span><span class="p">)</span><span class="w">

</span><span class="c1">## $confusion_matrix</span><span class="w">
</span><span class="c1">##     1 2  3  4  5  6  7  8  9 10 11 12</span><span class="w">
</span><span class="c1">## 1  14 0  0  2  0  0  0  0  3  1  0  0</span><span class="w">
</span><span class="c1">## 2   0 5  1  0  0  0  0  0  0  0  0  0</span><span class="w">
</span><span class="c1">## 3   0 4 43  2  0  0 12  0  0  0  8 13</span><span class="w">
</span><span class="c1">## 4   4 0  3 22  2  1  3  1  5  0  1  0</span><span class="w">
</span><span class="c1">## 5   0 0  0  0 60 17  3  0  7 19  3  2</span><span class="w">
</span><span class="c1">## 6   0 0  0  0 13 42  0  4  0  2  0  0</span><span class="w">
</span><span class="c1">## 7   1 0 12  7  2  0 72 18  2 13  3 13</span><span class="w">
</span><span class="c1">## 8   0 0  0  1  1  6 19 80  0  7  8  0</span><span class="w">
</span><span class="c1">## 9   0 0  0  8  3  0  5  1 29  0  0  1</span><span class="w">
</span><span class="c1">## 10  0 0  0  1  9  0  4  1  0 12  1  0</span><span class="w">
</span><span class="c1">## 11  0 0  9  0  1  1  0  4  0  0  9  0</span><span class="w">
</span><span class="c1">## 12  0 0  4  0  1  0  4  0  0  0  0  5</span><span class="w">
</span><span class="c1">## </span><span class="w">
</span><span class="c1">## $overall_accuracy</span><span class="w">
</span><span class="c1">## [1] 57</span><span class="w">
</span><span class="c1">## </span><span class="w">
</span><span class="c1">## $producers_accuracy</span><span class="w">
</span><span class="c1">##  1  2  3  4  5  6  7  8  9 10 11 12 </span><span class="w">
</span><span class="c1">## 74 56 60 52 66 63 60 74 64 23 28 15 </span><span class="w">
</span><span class="c1">## </span><span class="w">
</span><span class="c1">## $users_accuracy</span><span class="w">
</span><span class="c1">##  1  2  3  4  5  6  7  8  9 10 11 12 </span><span class="w">
</span><span class="c1">## 70 84 53 53 55 69 51 66 62 43 38 36 </span><span class="w">
</span><span class="c1">## </span><span class="w">
</span><span class="c1">## $kappa</span><span class="w">
</span><span class="c1">## [1] 0.5023977</span><span class="w">
</span></code></pre></div></div>

<p>Similarly, performing the out-of-bag evaluation requires first using the <code class="highlighter-rouge">pred.hv.MNLR</code> model to predict on the out-of-bag cases.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## goodness of fit (out-of-bag)</span><span class="w">
</span><span class="n">V.pred.hv.MNLR</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">predict</span><span class="p">(</span><span class="n">hv.MNLR</span><span class="p">,</span><span class="w"> </span><span class="n">newdata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DSM_data</span><span class="p">[</span><span class="o">-</span><span class="n">training</span><span class="p">,</span><span class="w"> </span><span class="p">])</span><span class="w">

</span><span class="n">ithir</span><span class="o">::</span><span class="n">goofcat</span><span class="p">(</span><span class="n">observed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DSM_data</span><span class="o">$</span><span class="n">terron</span><span class="p">[</span><span class="o">-</span><span class="n">training</span><span class="p">],</span><span class="w"> </span><span class="n">predicted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">V.pred.hv.MNLR</span><span class="p">)</span><span class="w">

</span><span class="c1">## $confusion_matrix</span><span class="w">
</span><span class="c1">##    1 2  3  4  5  6  7  8  9 10 11 12</span><span class="w">
</span><span class="c1">## 1  5 0  0  1  0  0  1  0  1  0  0  0</span><span class="w">
</span><span class="c1">## 2  1 0  0  0  0  0  0  0  0  0  0  0</span><span class="w">
</span><span class="c1">## 3  0 4 15  5  0  0  3  0  0  2  2  3</span><span class="w">
</span><span class="c1">## 4  2 0  1 11  0  1  1  0  0  0  0  0</span><span class="w">
</span><span class="c1">## 5  0 0  0  3 24  4  0  2  2  2  2  0</span><span class="w">
</span><span class="c1">## 6  0 0  0  0  7 17  0  2  1  0  0  0</span><span class="w">
</span><span class="c1">## 7  0 0  6  7  2  0 33  8  3  4  8  3</span><span class="w">
</span><span class="c1">## 8  0 0  0  1  1  3  6 26  1  5  0  1</span><span class="w">
</span><span class="c1">## 9  0 0  1  2  1  0  3  0 12  0  0  0</span><span class="w">
</span><span class="c1">## 10 0 0  0  0  5  0  1  0  0 10  0  3</span><span class="w">
</span><span class="c1">## 11 0 0  3  2  0  0  0  3  0  0  3  0</span><span class="w">
</span><span class="c1">## 12 0 0  1  0  0  0  5  0  0  1  0  1</span><span class="w">
</span><span class="c1">## </span><span class="w">
</span><span class="c1">## $overall_accuracy</span><span class="w">
</span><span class="c1">## [1] 53</span><span class="w">
</span><span class="c1">## </span><span class="w">
</span><span class="c1">## $producers_accuracy</span><span class="w">
</span><span class="c1">##  1  2  3  4  5  6  7  8  9 10 11 12 </span><span class="w">
</span><span class="c1">## 63  0 56 35 60 68 63 64 60 42 20 10 </span><span class="w">
</span><span class="c1">## </span><span class="w">
</span><span class="c1">## $users_accuracy</span><span class="w">
</span><span class="c1">##  1  2  3  4  5  6  7  8  9 10 11 12 </span><span class="w">
</span><span class="c1">## 63  0 45 69 62 63 45 60 64 53 28 13 </span><span class="w">
</span><span class="c1">## </span><span class="w">
</span><span class="c1">## $kappa</span><span class="w">
</span><span class="c1">## [1] 0.4600514</span><span class="w">
</span></code></pre></div></div>

<p><a href="#top">Back to top</a></p>

<h3 id="apply-model-spatially-">Apply model spatially <a id="s-5"></a></h3>

<p>Using the <code class="highlighter-rouge">terra::predict</code> function is the method for applying the <code class="highlighter-rouge">hv.MNLR</code> model across the whole area. Model extension can take a couple of forms for MNLR. It is possible for multinomial logistic regression to create the map of the most probable class, as well as the probabilities for all classes. The first script example below is for mapping the most probable class which is specified by setting the <code class="highlighter-rouge">type</code> parameter to
<code class="highlighter-rouge">class</code>. If probabilities are required <code class="highlighter-rouge">probs</code> would be used for the <code class="highlighter-rouge">type</code> parameter, together with specifying an <code class="highlighter-rouge">index</code> integer to indicate which class probabilities you wish to map.</p>

<p>The second script example below shows the parametisation for predicting the probabilities for Terron class 1.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## Apply model spatially class prediction</span><span class="w">
</span><span class="n">map.MNLR.c</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">terra</span><span class="o">::</span><span class="n">predict</span><span class="p">(</span><span class="n">object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hv.rasters</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hv.MNLR</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"class"</span><span class="p">)</span><span class="w">

</span><span class="c1"># class probabilities (for estimation of Terron 1)</span><span class="w">
</span><span class="n">map.MNLR.p</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">terra</span><span class="o">::</span><span class="n">predict</span><span class="p">(</span><span class="n">object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hv.rasters</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hv.MNLR</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"probs"</span><span class="p">,</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>Plotting the final map is done as below. You will also note the use of explicit colors for each Terron class as they were the same colors used in the Terron map presented by Malone et al. (2014). The colors are defined in terms of HEX color codes. A very good resource for selecting colors or deciding on color ramps for maps is <a href="https://colorbrewer2.org/#type=sequential&amp;sche e=BuGn&amp;n=3"><code class="highlighter-rouge">colorbrewer</code></a>.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## Plotting</span><span class="w">
</span><span class="n">map.MNLR.c</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">as.factor</span><span class="p">(</span><span class="n">map.MNLR.c</span><span class="p">)</span><span class="w">

</span><span class="c1">## HEX colors</span><span class="w">
</span><span class="n">area_colors</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"#FF0000"</span><span class="p">,</span><span class="w"> </span><span class="s2">"#38A800"</span><span class="p">,</span><span class="w"> </span><span class="s2">"#73DFFF"</span><span class="p">,</span><span class="w"> </span><span class="s2">"#FFEBAF"</span><span class="p">,</span><span class="w"> </span><span class="s2">"#A8A800"</span><span class="p">,</span><span class="w"> </span><span class="s2">"#0070FF"</span><span class="p">,</span><span class="w"> </span><span class="s2">"#FFA77F"</span><span class="p">,</span><span class="w"> </span><span class="s2">"#7AF5CA"</span><span class="p">,</span><span class="w"> </span><span class="s2">"#D7B09E"</span><span class="p">,</span><span class="w"> </span><span class="s2">"#CCCCCC"</span><span class="p">,</span><span class="w"> </span><span class="s2">"#B4D79E"</span><span class="p">,</span><span class="w"> </span><span class="s2">"#FFFF00"</span><span class="p">)</span><span class="w">

</span><span class="n">terra</span><span class="o">::</span><span class="n">plot</span><span class="p">(</span><span class="n">map.MNLR.c</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">area_colors</span><span class="p">,</span><span class="w"> </span><span class="n">plg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="n">legend</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"HVT_001"</span><span class="p">,</span><span class="w"> </span><span class="s2">"HVT_002"</span><span class="p">,</span><span class="w"> </span><span class="s2">"HVT_003"</span><span class="p">,</span><span class="w"> </span><span class="s2">"HVT_004"</span><span class="p">,</span><span class="w"> </span><span class="s2">"HVT_005"</span><span class="p">,</span><span class="w"> </span><span class="s2">"HVT_006"</span><span class="p">,</span><span class="w"> </span><span class="s2">"HVT_007"</span><span class="p">,</span><span class="w"> </span><span class="s2">"HVT_008"</span><span class="p">,</span><span class="w"> </span><span class="s2">"HVT_009"</span><span class="p">,</span><span class="w"> </span><span class="s2">"HVT_010"</span><span class="p">,</span><span class="w"> </span><span class="s2">"HVT_011"</span><span class="p">,</span><span class="w"> </span><span class="s2">"HVT_012"</span><span class="p">),</span><span class="w"> </span><span class="n">cex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.75</span><span class="p">,</span><span class="w"> </span><span class="n">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Terron Class"</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<figure>
<img src="/images/dsm_book/P6_mnlr_map.png" alt="rconsole" />
<figcaption>
Hunter Valley most probable Terron class map created using multinomial logistic regression model.
</figcaption>
</figure>

<p><a href="#top">Back to top</a></p>

<h3 id="references">References</h3>

<p>Kempen, B, D. J Brus, G. B. M Heuvelink, and J. J Stoorvogel. 2009. “Updating the 1:50,000 Dutch Soil Map Using Legacy Soil Data: A Multinomial Logistic Regression Approach.” <em>Geoderma</em> 151: 311–26.</p>

<p>Malone, B P, P Hughes, A B McBratney, and B Minsany. 2014. “A Model for the Identification of Terrons in the Lower Hunter Valley, Australia.” <em>Geoderma Regional</em> 1: 31–47.</p>

      <footer class="entry-meta">
        <span>Updated on <span class="entry-date date published updated"><time datetime="2023-09-19">September 19, 2023</time></span></span>
        <span class="author vcard"><span class="fn">Smart Digital Agriculture</span></span>
        <div class="social-share">
  <ul class="socialcount socialcount-small inline-list">
    <li class="facebook"><a href="https://www.facebook.com/sharer/sharer.php?u=/DSM_book/pages/dsm_cat/mlr/" title="Share on Facebook"><span class="count"><i class="fa fa-facebook-square"></i> Like</span></a></li>
    <li class="twitter"><a href="https://twitter.com/intent/tweet?text=/DSM_book/pages/dsm_cat/mlr/" title="Share on Twitter"><span class="count"><i class="fa fa-twitter-square"></i> Tweet</span></a></li>
    <li class="googleplus"><a href="https://plus.google.com/share?url=/DSM_book/pages/dsm_cat/mlr/" title="Share on Google Plus"><span class="count"><i class="fa fa-google-plus-square"></i> +1</span></a></li>
  </ul>
</div><!-- /.social-share -->
      </footer>
    </div><!-- /.entry-content -->
    
  </article>
</div><!-- /#main -->

<div class="footer-wrapper">
    <!--<span>&copy; 2025 Smart Digital Agriculture. Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> using the <a href="http://mademistakes.com/hpstr/" rel="notfollow">HPSTR Theme</a>.</span>-->

<footer role="contentinfo">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    <li>
                        <a href="/feed.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    <li>
                        <a href="mailto:malone.brendan1001@gmail.com">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="https://github.com/brendo1001">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="https://twitter.com/soilmalone">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    
                </ul>
                <p class="copyright text-muted">Copyright &copy; Smart Digital Agriculture 2025, All Rights Reserved.</p>
            </div>
        </div>
    </div>
</footer>

</div><!-- /.footer-wrapper -->

<!-- JQuery JavaScript -->
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>

<!-- Bootstrap Core JavaScript -->
<script src="/assets/js/vendor/bootstrap.min.js"></script>

<!-- Clean Blog JavaScript -->
<script src="/assets/js/clean-blog.min.js"></script>

<script src="/assets/js/scripts.min.js"></script>


<!-- Asynchronous Google Analytics snippet -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-87285093-1', 'auto');
  ga('require', 'linkid', 'linkid.js');
  ga('send', 'pageview');
</script>


<!-- Math equation support by MathJax -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        TeX: {
            equationNumbers: { autoNumber: "all" },
            inlineMath: [['$','$'],['\\(','\\)']],
        },
        "HTML-CSS": {
            availableFonts: ["TeX"],
            preferredFont: "TeX",
        },
    });
</script>
<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML"></script>




</body>
</html>
